Journal of Neuroscience Methods 139 (2004) 13–24

3D-catFISH: a system for automated quantitative three-dimensional compartmental analysis of temporal gene transcription activity imaged by ﬂuorescence in situ hybridization
Monica K. Chawla b,1 , Gang Lin a,b,1 , Kathy Olson b , Almira Vazdarjanova b , Sara N. Burke b , Bruce L. McNaughton b , Paul F. Worley c , John F. Guzowski d , Badrinath Roysam a , Carol A. Barnes b,∗
b

ECSE Department, Rensselaer Polytechnic Institute, Troy, NY 12180, USA Neural Systems, Memory, and Aging Division, Life Sciences North Bldg., Rm. 384, University of Arizona, Tucson, AZ 85724, USA c Department of Neuroscience, Johns Hopkins University, Baltimore, MD 21205, USA d Department of Neurosciences, University of New Mexico, Albuquerque, NM 87131, USA Received 29 January 2004; received in revised form 9 April 2004; accepted 9 April 2004

a

Abstract Fluorescence in situ hybridization (FISH) of neural activity-regulated, immediate-early gene (IEG) expression provides a method of functional brain imaging with cellular resolution. This enables the identiﬁcation, in one brain, of which speciﬁc principal neurons were active during each of two distinct behavioral epochs. The unprecedented potential of this differential method for large-scale analysis of functional neural circuits is limited, however, by the time-intensive nature of manual image analysis. A comprehensive software tool for processing three-dimensional, multi-spectral confocal image stacks is described which supports the automation of this analysis. Nuclei counterstained with conventional DNA dyes and FISH signals indicating the sub-cellular distribution of speciﬁc, IEG RNA species are imaged using different spectral channels. The DNA channel data are segmented into individual nuclei by a three-dimensional multi-step algorithm that corrects for depth-dependent attenuation, non-isotropic voxels, and imaging noise. Intra-nuclear and cytoplasmic FISH signals are associated spatially with the nuclear segmentation results to generate a detailed tabular/database and graphic representation. Here we present a comprehensive validation of data generated by the automated software against manual quantiﬁcation by human experts on hippocampal and parietal cortical regions (96.5% concordance with multi-expert consensus). The high degree of reliability and accuracy suggests that the software will generalize well to multiple brain areas and eventually to large-scale brain analysis. © 2004 Elsevier B.V. All rights reserved.
Keywords: Cell nuclei; Segmentation; Confocal microscopy; Cell counting; Image analysis; catFISH

1. Introduction One of the greatest challenges facing neuroscience is to understand the basis of behavior and cognition in terms of the coherent activity of large ensembles of neurons, distributed widely throughout the brain. This requires the ability to identify, within the same brain, which neurons participated in each of two different epochs of behavior and/or cognitive processing so that activity critical to a process of
∗ Corresponding author. Tel.: +1-520-626-2616; fax: +1-520-626-2618. E-mail address: carol@nsma.arizona.edu (C.A. Barnes). 1 These authors have contributed equally.

interest can be dissociated from activity that is not speciﬁc to that process. Such differential functional imaging approach is widely used in non-invasive functional imaging studies (e.g., PET, fMRI) that can dissociate regions of differential activation. These methods, however, cannot address the question of which neurons were involved in particular processes. In contrast, multi-neuron recording studies (Barnes et al., 1997; Gothard et al., 1996; Hoffman and McNaughton, 2002; Nicolelis et al., 1997, 2003; Wilson and McNaughton, 1993) provide the necessary cellular and temporal resolution, but are severely limited in terms of the number of neurons that can be analyzed. In the past few years, our collaborative research group has developed a novel brain imaging method—cellular compartment analysis of

0165-0270/$ – see front matter © 2004 Elsevier B.V. All rights reserved. doi:10.1016/j.jneumeth.2004.04.017

14

M.K. Chawla et al. / Journal of Neuroscience Methods 139 (2004) 13–24

temporal activity by Fluorescence in situ hybridization or “catFISH”—that provides both temporal and cellular resolution, but can only be applied to behavioral studies in animal models. In the Arc catFISH technique RNA transcription at individual alleles in the nucleus is detected as bright transcription foci within 2 min after neuronal activity. Subsequently the Arc RNA translocates to the cytoplasm where it can be detected as diffuse staining around the nucleus within 30 min. Since the RNA appears and disappears in each compartment with a precise time course, the activity history of each neuron can be assessed during two behavioral epochs (separated by 30 min) in the same animal (Guzowski et al., 1999), thus providing a powerful technology for mapping functional brain circuits involved in different behavioral experiences. A variation of Arc catFISH utilizes another IEG, Homer 1a instead of cytoplasmic Arc RNA (Bottai et al., 2002; Vazdarjanova et al., 2002). This method takes advantage of the fact that the time course of Homer la transcription foci is exactly the same as cytoplasmic Arc. Since it is technically easier to measure transcription foci within the nucleus we have also utilized Arc/Homer 1a catFISH. Despite the technical and conceptual breakthrough of catFISH, challenges exist for cell circuit analysis of given behaviors. One of the primary challenges is the time-consuming nature of manual counting methods used for analysis. Reliance on completely manual methods will limit the potential breakthroughs that large-scale catFISH technology promises. To this end, we have developed several algorithms for automated three-dimensional cell nuclei segmentation and FISH quantiﬁcation for monitoring gene activity from confocal image stacks. These algorithms have been organized and combined under a graphical user interface (GUI), referred to as “3D-catFISH”. In the present report, the performance of this software is compared rigorously against manually collected data on the same brain regions by several independent expert observers. The outcome of this analysis suggests that the performance characteristics of 3D-catFISH are outstanding and comparable to those obtained by manual analysis.

Nutley, NJ). The plasmids used to generate Arc or Homer 1a riboprobes contain a full-length cDNA (3.0 or 5.3 kb of the Arc or Homer 1a transcript, respectively) (Lyford et al., 1995). Fluorescence in situ hybridization was performed as described in detail elsewhere by Bottai et al. (2002) and Guzowski et al. (2001). Digoxigenin-labeled Arc or Fluoroscein-labeled Homer 1a riboprobes were detected with anti-digoxigenin-HRP or antiﬂuoroscein-labeled-HRP (Roche Molecular Biochemicals) and a CY3 or CY5 substrate kit (Perkin-Elmer, Boston, MA). Nuclei were counterstained with either Sytox Green or YOYO-1 (Molecular Probes, Eugene, OR). 2.2. Confocal image acquisition for catFISH Images were acquired using a Leica TCS-4D confocal microscope equipped with a krypton/argon laser. Depending on the required analysis, the settings were adjusted to optimize either the appearance of cytoplasmic labeling, or that of intra-nuclear foci of transcription. For some of the foci series, images were acquired using Homer la foci instead of cytoplasmic Arc. Optimization for foci was achieved by increasing the offset of the microscope’s photo-multiplier tube (PMT). Stacks of 1 m thick optical sections were acquired with a Plan Apo achromatic 40× oil objective with a numerical aperture of 1.2 and working distance of 0.88 mm. Typical sampling resolution along x-, y- and z-direction was 0.45, 0.45 and 1.0 m, respectively. At the imaging wavelengths (488, 568, and 647 nm) and for the lens used, the chromatic aberrations are not substantial enough to warrant an elaborate correction, so none was performed. The specimen stage resolution of 1 m was comparable to the calculated Airy axial resolutions in the range of 0.9–1.2 m. Combined with the fact that only the FISH spots that are larger than a set threshold volume, and brighter than a set intensity value (see Section 2.6 below) are considered for subsequent comparative analysis, time-consuming deconvolution of the confocal stacks was not considered essential for the present study (Holmes et al., 1995). Features of typical confocal images are illustrated in Fig. 1, containing a single optical slice from a three-dimensional confocal image of the CA1, CA3, fascia dentata and parietal cortex regions of the rat (top left, top right, lower right and lower left, respectively). These images were acquired with a Zeiss 510 Metaseries confocal microscope. A 40× Plan NeoFluar objective with a 1.3 numerical aperture and working distance of 0.12 mm was used. The blue-colored objects are the ﬂuorescence labeled cell nuclei. The green signal indicates RNA of the immediate-early gene Homer 1a and the red signal is Arc, as revealed by ﬂuorescence in situ hybridization. Red and green spots in the nucleus are transcriptional sites and when present, are referred to as “intra-nuclear FISH”. When the red or green FISH product appears just outside of the nuclear boundaries (which occurs at a temporal delay after

2. Materials and methods 2.1. Tissue preparation for catFISH Following decapitation with a rodent guillotine, the brains were rapidly removed and quick-frozen in isopentane (∼ −50 ◦ C) and then stored at −70 ◦ C until sectioned on a cryostat. Twenty micron thick sections were mounted on slides, such that all groups were represented on each slide. We have found that 20–25 m thick sections are optimal in terms of cRNA probe penetration during in situ hybridization. However, 40 m thick sections are routinely used in ﬂuorescence immunohistochemical procedures. Hapten-labeled riboprobes were generated using commercial transcription kits (MaxiScript; Ambion, Austin, TX) and RNA labeling mixes (Roche Molecular Biochemicals,

M.K. Chawla et al. / Journal of Neuroscience Methods 139 (2004) 13–24

15

Fig. 1. Representative confocal images were taken on a Zeiss 510 Metaseries confocal microscope with a 40× oil objective. Three different sub-regions, CA1, CA3 and fascia dentata (DG) of the rat hippocampus are shown along with an image from the rat parietal cortex (CTX). The nuclei shown in blue represent DNA staining (counterstain), FISH signals are either green (Homer 1a) or red (Arc) and are located in the nucleus (foci) or surrounding the nucleus (cytoplasmic). The foci depicting transcriptional activity ﬁrst appear in the nucleus and then translocate to the cytoplasm with a gene-speciﬁc temporal delay (Bottai et al., 2002; Vazdarjanova et al., 2002).

the intra-nuclear FISH), it is referred to as “extra-nuclear” or “cytoplasmic FISH”. 2.3. Overview of the 3D-catFISH software system The main steps of the software system are illustrated in Fig. 2. Confocal images are ﬁrst obtained in multiple spectral channels and loaded onto the computer. The nuclear channel represents the counterstained nuclei and is ﬁrst segmented using the three-dimensional watershed algorithm (described in Section 2.4), followed by a model-based region merging of the nuclei. Any of the cell types such as glia, which are to be excluded from the analysis are then removed by an agglomerative clustering algorithm. Intra-nuclear and cytoplasmic FISH signals are then detected and quantiﬁed using the other ﬂuorescence channels. Finally, the measurements

of nuclear segmentation, intra-nuclear and cytoplasmic FISH are integrated and associated spatially and a detailed tabular representation is generated. Classiﬁcation of nuclei based upon the location and detailed morphometric parameters for each nucleus and the associated FISH signals is performed and the data is output to a spreadsheet for further statistical analyses. 2.4. Cell nuclei segmentation using 3D-catFISH Accurate, reliable, and highly automated segmentation of ﬂuorescence-labeled cell nuclei from three-dimensional confocal images is the essential ﬁrst step for quantiﬁcation and localization of gene products in nuclear or cytoplasmic compartments. A common problem for segmentation algorithms is the issue of tightly packed cell layers, which often result

16

M.K. Chawla et al. / Journal of Neuroscience Methods 139 (2004) 13–24

Fig. 2. An overview of the 3D- software system is shown. Confocal images of tissue sections are obtained in multiple spectral channels. One channel represents the DNA-labeled nuclei (counterstain). The remaining channels represent one or more ﬂuorescence labels. Nuclei are ﬁrst segmented using an enhanced three-dimensional watershed algorithm (deﬁned in Section 2.4.1), followed by a model-based region merging procedure. The next step is to remove the unwanted glial/non-neuronal cells by an agglomerative clustering algorithm. Then, both intra-nuclear and cytoplasmic FISH signal are detected and quantiﬁed from the ﬂuorescence channels. These measurements are integrated and associated spatially with the nuclear segmentation results to generate a database. Users can then deﬁne classes for the categorization and statistical analysis of nuclei.

in the appearance of “touching objects” in the image stacks. Precise segmentation of nuclei is an absolute requirement for catFISH analysis, as the detection and classiﬁcation assignment of gene products to nuclear versus cytoplasmic locations is critical for achieving optimal temporal resolution. 2.4.1. Enhanced three-dimensional watershed algorithm We have developed algorithms that greatly improve upon previous segmentation approaches, which are described in detail elsewhere (Lin et al., 2003). Improvements were accomplished through two means, one included the development of a transform that combines intensity/gradients and the geometric distance in the watershed step, and an explicit mathematical model for the anatomical characteristics of cell nuclei (e.g., size and shape) was incorporated. The watershed algorithm has been widely studied and used for efﬁcient object separation (Mackin et al., 1998), but has several limitations. These limitations arise from the fact that the watershed method relies on touching objects exhibiting a narrow “neck” in the region of contact. These proﬁles play a critical early role in estimating the number of objects in a given cluster. This process is notoriously error-prone. Considerable effort has been devoted to the design of algorithms for generating the correct set of “markers” to guide the object segmentation. The problem of determining the correct number of markers is inherently a difﬁcult one, and is conceptually similar to the problem of automatically determining the number of groups in multi-dimensional statistical data (Theodoridis and Koutroumbas, 1999). To overcome the above difﬁculties, we have developed a combined image transformation called the “gradient-weighted distance transform”, which combines object separation hints from geometric and intensity cues in the images. Speciﬁcally, the

geometric-distance transform, calculated from Chamfer distance transform described by Borgefors (1986), and the gradient transform (Lin et al., 2003) are combined into a single representation that captures the object separation cues available in the data. 2.4.2. Model-based object merging method After the three-dimensional watershed algorithm has been carried out using the gradient weighted distance transform described above, under-segmentation can be nearly eliminated, but the problem of over-segmentation remains. To correct the over-segmentation, it is necessary to detect and break (eliminate) the false watershed surfaces and thereby merge cell objects (Adiga and Chaudhuri, 2001; Lin et al., 2003). The object model is denoted by a vector, which includes various measurements such as volume, texture, convexity, circularity and shape. Further details concerning the above algorithms are provided in Lin et al. (2003). A typical segmentation result of a confocal image stack using the proposed enhanced three-dimensional watershed algorithm followed by the model-based region merging procedure is shown in Fig. 3A. 2.5. Glial cell removal by the agglomerative method As illustrated in Fig. 3B, some glial/non-neuronal cells (yellow arrows) are normally present in the three-dimensional image stacks. At present, glial/non-neuronal cells are eliminated from further analysis because they do not express either Arc or Homer 1a (Vazdarjanova et al., 2003). If these cells were to be of interest, then the proposed methods can be used to isolate them for further processing. Glial nuclei differ from other nuclei in three features: intensity,

M.K. Chawla et al. / Journal of Neuroscience Methods 139 (2004) 13–24

17

Fig. 3. Panel (A) is the segmentation result using the algorithm with enhanced (see text Section 2.4.1 for details) three-dimensional watershed segmentation followed by model-based merging. Panel (B) shows the cell nuclei (outlined in blue) after eliminating the glial/non-neuronal cells, as indicated by yellow arrows. Panel (C) shows the two-dimensional projected segmentation with nuclear boundaries and labels.

texture and homogeneity. In contrast with neurons, glial cells tend to be brighter in intensity with a relatively uniform pixel intensity distributed across their entire volume. Therefore, intensity, texture and homogeneity are chosen as the three measurements for discriminating the glial cells from neurons. We adopted an agglomerative classiﬁcation algorithm based on matrix theory to classify these two classes. Mathematically, let X = {X1 , X2 , . . . , XN } denote the feature set of a total of N-cells, which need to be classiﬁed. Let g(Ci , Cj ) denote a function deﬁned for all possible pairs of feature clusters of X, which measures the proximity between cluster Ci and Cj . Let t denote the current level of the classiﬁcation hierarchy. The agglomerative classiﬁcation procedure creates a hierarchy of N feature clusters so that each one is nested in all successive clusters. Mathematically, it is expressed as Ri ⊂ Rs for t < s, s = 1, 2, . . . , N − 1. The initial input to the agglomerative classiﬁcation scheme is the N × N dissimilarity matrix, P 0

= P(X) derived from X, whose (i, j)th element equals the dissimilarity d(xi , xj ) between feature vector xi .and xj . In this work, each feature vector is formed by three components: intensity, texture and a homogeneity measure. At each hierarchical level t, two classes are merged into one, and the size of dissimilarity matrix P t at this level is (N − t) × (N − t). P t follows from P t−1 by deleting the two rows and columns that correspond to the merged clusters and adding a new row and a new column that contain the distances between the newly formed cluster and the old (unaffected at this level) clusters. The distance between a newly formed cluster Cq (the resulting of merging Ci and Cj ) and an old cluster, Cs , is calculated in the form: d(Cq , Cs ) = (ni /(ni + nj ))d(Ci , Cs ) + (ni /(ni + nj ))d(Cj , Cs ) where ni and nj are he cardinalities of Ci and Cj , respectively. The following is a detailed description of the agglomerative clustering by a matrix update-based algorithm. Note that in our case, we know beforehand that the set of cells

18

M.K. Chawla et al. / Journal of Neuroscience Methods 139 (2004) 13–24

is going to be partitioned into two classes: normal and glial cells. Therefore, the highest level of the hierarchy in our agglomerative algorithm is N − 2. Set initial clustering R0 = {Ci = {xi }, i = 1, . . . , N}. Initialize dissimilarity matrix P 0 = P(X). For t = 1–2 do: (a) Find Ci , Cj such that d(Ci , Cj ) = minr,s=1,... ,N,r=s d(Cr , Cs ). (b) Merge Ci and Cj into a single Cq and form Rt = (Rt−1 − {Ci , Cj }) ∪ {Cq }. Update the dissimilarity matrix P t from P t−1 . Then identify glial cell clusters in the ﬁnal two clusters and remove them. 2.6. FISH quantiﬁcation and nuclear classiﬁcation As illustrated in Fig. 1, high-resolution in situ hybridization methods permit the visualization of RNA that appears within distinct sub-cellular compartments of the neuron. Following neuronal stimulation, Arc RNA ﬁrst appears in the nucleus at discrete foci (red spots). Subsequently, Arc translocates from the nucleus to the cell cytoplasm. We have developed automated and computationally efﬁcient algorithms for classiﬁcation of the FISH signal. This algorithm identiﬁes whether spectrally identiﬁable FISH product is present in the cell nucleus or in the cytoplasm. First the algorithm segments cell nuclei in the three-dimensional image stack, then non-neuronal cells are removed. FISH signal is then quantiﬁed, and cells classiﬁed based on the presence of intra-nuclear or extra-nuclear/cytoplasmic FISH. As shown in Fig. 1, intra-nuclear FISH is revealed by bright spots inside the boundary of cell nuclei in the FISH color channel, which is distinct from the nuclear counter stain. Because the cytoplasmic FISH signals are distributed in the region immediately surrounding the nuclei (usually close to the nuclear membrane), to measure the cytoplasmic FISH signal, the background voxels are suppressed by intensity thresholding (i.e., any voxels with intensity value smaller than a pre-speciﬁed threshold are set to zero). Foreground voxels (nonzero) that are adjacent to the nucleus are then measured. 2.6.1. Intra-nuclear FISH quantiﬁcation Within the interior region of each cell nucleus, morphological ﬁltering (an opening followed by closing operation) is applied to the pixels in the desired FISH channel h ∈ {R, G, B}. Then, connected components are detected, which results in a set of FISH signal “spots” in the h channel. Simply classifying whether the nucleus is intra-nuclear FISH positive or not based on these spots often results in false positives. To avoid this problem, we measure the maximum pixel intensity of each spot p, and the size (number of pixels) of p. Then, all spots are ﬁltered by a maximum intensity threshold value that is denoted as Mlt , and a size threshold denoted as St MIt and St are set empirically by the user. In other words, only those spots whose maximum intensity is larger than Mlt , and whose size is larger than St are deemed to represent a true FISH signal. We can thus determine whether a nucleus is intra-nuclear positive based on whether there are FISH spots in the h channel within

the nucleus boundary. The default foci size threshold can be adjusted if a visual check reveals that the 3D-catFISH software excluded “true” foci on the basis of their size. 2.6.2. Cytoplasmic FISH signal quantiﬁcation To determine whether a nucleus is cytoplasmic FISH positive in a certain channel h, we introduce two new measurements: the ﬁrst of these is termed the “cytoplasmic FISH distribution” (CFD). The second of these is termed the “cytoplasmic FISH angular diversity” (CFA). Each of these measures is described below. The cytoplasmic FISH distribution measure: First we specify a “zone-of-interest,” denoted Zk , for each nucleus C, which is a shell immediately surrounding the outside of each nucleus, with a k-pixel width (typically k = 2). This zone is obtained by subtracting a morphologically dilated version of itself. This can be represented mathematically as follows: Zk = dilate(C,k) − C. The cytoplasmic FISH pixels in region Zk can be described as the set of pixels whose intensity is greater than a set threshold It . If this subset of the zone Zk is denoted Zk (It ), it can be described mathematically as follows: Zk (It ) = {x|x ∈ h h Zk &Ix ≥ It }, where Ix denotes the intensity of pixel x in the FISH channel h, and It is the pre-speciﬁed threshold. The CFD is calculated as the ratio of number of FISH pixels and the total number of nucleus pixels (volume), and expressed mathematically as follows: CFD = |Zk (It )| , |Zk | where “| |” denotes the size of the set.

Cytoplasmic FISH positive nuclei have the following two characteristics: (1) the cytoplasmic spots are present just outside of nuclear boundary; and (2) the cytoplasmic FISH signal is distributed surrounding the nucleus in many directions. The measurement of CFD as deﬁned above reﬂects condition (1). Condition (2) is accounted for by the second measure CFA, which is described next. The cytoplasmic FISH angular diversity measure (CFA): ﬁrst we project the cytoplasmic FISH pixels Zk (It ) onto a single x–y plane. Let Zk 2D (It ) = {xl , x2 , . . . , xn } denote the two-dimensional projected cytoplasmic FISH pixels, and is the center of cell nucleus on the projection plane. Let θ i be the angle between each xi and x-axis, where −π < θi ≤ π. Then, cytoplasmic FISH angular diversity CFA is deﬁned by the standard deviation of the absolute values of angle set θ = {θl , θ2 , . . . , θn } and is denoted as: CFA = σ(|θ|) = ¯ ¯ 1/(n − 1) n (|θi |) − θ)2 where θ = ( n |θi |)/n. i=1 i=1 Combining the above two measurements CFD and CFA, our ﬁnal criterion for determining whether a nucleus is cytoplasmic FISH positive or not in channel h is given by: CF = CFD × CFA > CFt . The above criterion can be thought of as an “angular diversity-weighted distribution”. If the CF value for a given nucleus is greater than a certain threshold CFt , we say it is cytoplasmic FISH positive and vice versa.

M.K. Chawla et al. / Journal of Neuroscience Methods 139 (2004) 13–24

19

2.7. Components of the 3D-catFISH software system 2.7.1. Graphical user interface The algorithms described above have been integrated into a software system based on the Interactive Data Language (IDL, Research Systems Inc., Boulder, CO). Performance-critical routines have been written in the C++ language and linked to the IDL platform. Table 1 provides the main buttons of the 3D-catFISH GUI along with their functional descriptions. The major functions of GUI are organized into the following categories. (1) Segmentation automates cell nucleus segmentation including the three-dimensional watershed procedure and model-based post-processing. Since we are interested in including only whole cells, neuronal nuclei within the median 20% of the z-stack range are selected for analysis, which is basically an optical disector method. The program applies the 20% median planes rule, eliminating any nuclei having no visible pixels in the median planes from being counted (eliminating

partial cells). (2) Interactive editing includes many tools for manual operations such as nucleus add/delete, split/merge, etc. (Fig. 4). (3) FISH activity calculates and analyzes the intra-nuclear and cytoplasmic FISH signal on the segmented image, then classiﬁes the cell nuclei based on their signal measurements according to user deﬁned nuclear classes. (4) Additional tools of the graphical user interface are provided in Tables 1 and 2. 2.7.2. Major inputs 2.7.2.1. Image stack. The input image is a three-dimensional microscope image stack with three color channels Ii = (Ri , Gi , Bi ), i = 0, 1, . . . , k − 1, where k is the number of slices, typically k = 25, frame size is 512 × 512. The image format is usually a TIFF series. Nuclear class deﬁnition: the second major input is nuclear classes that are speciﬁed by the user through the GUI. We use 1 byte to encode the class information, i.e., the bits 0, 1, and 2 of the

Table 1 Partial list of functions available in the 3D-catFISH program to facilitate user interactions with the automated analyses is shown Category Segmentation Function PARJNPUT READ IMG WTD SEG REM GLIA MODEL MERGE REM CUT FINALIZE SAVE READ SEG FISH activity CLASS CLEAR CLASS DEFINE FISH DETECT CLASSIFY FISH VIEW Interactive editing SPLIT MERGE DELETE UNDO DEL DILATE SHRINK ADD NUC INFO GALLERY SET ROI RESTORE ZOOM REFRESH Bound ch Nuclear ch Foci ch Switches HELP QUIT Description of function An interface that allows the user to input parameter values, such as nuclear and FISH thresholds or feature options etc Dialog window for loading three-dimensiona; image stack Implements the enhanced three-dimensiona; watershed segmentation Removes the glial cells from image Performs model-based merging to eliminate over-segmentation Eliminates those nuclei that are cut by x, y and z-axes, and only keeps the intact nuclei for FISH analysis Removes artifacts using a volume threshold, and reorders the nuclear labels Projects all cells onto a single z plane using their widest boundary, and saves it into a ﬁle Reads the segmentation result from the ﬁle saved previously Deletes the previously existing class deﬁnitions for cells An interface that allows the user to specify class deﬁnitions, by indicating the color channel and location of the FISH signal. Quantiﬁes intra-nuclear and/or cytoplasmic FISH adaptively based on user deﬁned classes Classiﬁes the cell nuclei based on the presence of FISH Displays the FISH information for a speciﬁed nucleus Interactively separates a cell cluster Merges two or more selected nuclei Deletes some unwanted nuclei Recovers accidentally deleted nuclei Dilates the boundary of a selected nucleus Shrinks the boundary of a selected nucleus Adds a cell nucleus Displays the features of the selected cell nuclei Gallery view of the selected nuclei Draws a region-of-interest on screen to exclude some unwanted cell nuclei for further consideration Restores the original image data in order to restart the operations without re-loading image Zooms in/out the current image Refreshes the display Selects the color of nucleus boundary Selects the color for nucleus channel Selects color channel for detecting FISH signals Turns on/off the color channel, nucleus labels or boundaries Displays a help message Terminates the program

Some tools

20

M.K. Chawla et al. / Journal of Neuroscience Methods 139 (2004) 13–24

byte represents the cytoplasmic FISH in the color channel R, G, and B, respectively, with “1” meaning positive and “0” meaning negative. Similarly, bits 3 through ﬁve encode whether or not the cell nucleus is positive for intra-nuclear FISH in R, G and B. Depending on the number of color channels that intra-nuclear and cytoplasmic FISH are present in, this byte representation can represent up to 64 different classes of nuclei. Also, the user is allowed to input a name for each of these nuclear classes. Other input data include some parameters for cell nuclei segmentation and classiﬁcation, such as x, y and z sampling size, nucleus volume threshold, etc. 2.7.3. Main outputs The main outputs of 3D-catFISH include (1) segmentation results, stored in a three-dimensional integer array with the same dimensions of the original image. Each element takes a value of either zero indicating background, or nonzero integer indicating the label of the cell nuclei to which the pixels belong. Also, the two-dimensional projected segmentation image displayed by nuclear boundaries and labels can be saved, as shown in Fig. 3C. (2) Nuclear and FISH measurements are used for both nuclear segmen-

Fig. 4. Series of confocal images illustrating manual editing of the software tools: (A) Add/delete; note that cell #19 has been added (B) Split/merge; cell #9 has been split into cell #9 and 4 and ﬁnally in (C) the Dilate/shrink function enables the boundary of cell #10 to be expanded.

Fig. 5. Nuclear classiﬁcations obtained by 3D-catFISH and censensus counts were used to generate regression plots for several measured parameters. Data for the foci series included all four categories-nuclei with no labeling; nuclei with positive Arc labeling, nuclei with positive Homeria labeling and nuclei containing both Arc and Homeria labeling. Data for the cytoplasmic series included two classiﬁcations-cells that were negative for cytoplasmic Arc and cells that were positive for cytoplasmic Arc. Plots A and C are from the foci-series of CA1 and parietal cortex, respectively (R2 = 0.98 and 0.99) and plots B and D are from the cytoplasmic series of CA1 and parietal cortex, respectively (R2 = 0.99 and 0.99).

M.K. Chawla et al. / Journal of Neuroscience Methods 139 (2004) 13–24

21

Table 2 Example of the spreadsheet generated by the 3D-catFISH software, containing the data obtained from each segmented cell nucleus (label = unique identiﬁcation number; volume = the total number of voxels inside the nucleus; average intensity = the average intensity values of all voxels within the nucleus). For the columns below intra-nuclear FISH, spot number = the number of separate FISH signals within the nucleus; size = the number of voxels within a FISH spot; maximum intensity = the maximum intensity values of all voxels within a FISH spot. Under the cytoplasmic FISH column, distribution = the ratio of number of FISH voxels and the total number of voxels in a surrounding region of the nucleus. The ﬁnal classiﬁcation is indicated by numbers in the last column, 0 = no signal; 1 = Arc foci-positive; 2 = Arc cytoplasmic-positive; 3 = Arc foci and cytoplasmic-positive. Note that in this example, the image contains intra-nuclear and cytoplasmic FISH signals only in the red channel Nuclear data Label 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Volume 1767 1664 3085 2576 1754 2615 3031 2563 2908 1859 2868 2624 2140 2518 3002 2837 1551 Average intensity 197 198 114 119 106 211 183 150 214 101 198 187 124 186 122 100 184 Intra-nuclear FISH Spot number 2 1 1 0 0 0 0 0 1 2 2 1 2 1 1 1 1 Size 285, 782 1705 0 0 0 0 0 61 218, 929, 361 783, 139 1995 2017 136 243 Maximum intensity 255, 255 255 0 0 0 0 0 255 255, 251, 255 255, 255 255 255 255 255 Cytoplasmic FISH Distortion 47.8 52.9 37.72 21.47 14.99 14.94 11.27 26.33 20.61 38.01 62.57 35.06 57.8 22.71 71.04 51.67 24.9 3 3 3 0 0 0 0 0 1 3 3 3 3 1 3 3 1 Class

270 301 46

255 255 255

tation and classiﬁcation, including nuclear features (such as volume, intensity, texture, shape) and FISH quantitative measurements (such as FISH spot size and maximum intensity value, etc.). An example spreadsheet of these data is shown in Fig. 5. As a byproduct, the data can be used later for manual evaluation to verify the accuracy of the automated results generated by the software system. Details of nuclear segmentation were included in Lin et al. (2003). (3) Classiﬁcation of nuclei is accomplished after users deﬁne each class (i.e., color channels, presence or absence of FISH signal and location of the signal). The system then automatically assigns each nucleus as being negative or containing intra-nuclear and/or cytoplasmic FISH signal. The ﬁnal result is output into a text ﬁle that also includes total nuclear count and the number and percentage of nuclei in each class. In order to demonstrate the effectiveness and accuracy of the software, the results obtained was validated by comparing them with manual results obtained by multiple experts. 2.8. Manual image analysis The manual image analysis was performed using MetaMorph software (Universal Imaging Corporation, West Chester, PA). For each three-dimensional stack, only whole nuclei were selected for analysis. As with the automated analysis, glial/non-neuronal cells recognized by their bright, homogenous staining, smaller size and lack of Arc/Homer 1a gene expression, were excluded. Also excluded were damaged nuclei, clustered nuclei, and nuclei containing

portions hidden by an overlapping nucleus on three or more planes. The criteria used by experts for evaluating intranuclear foci and cytoplasmic staining characteristics were as follows: First, the thresholds for foci size and intensity, and thresholds for cytoplasmic distribution were set. For a cell to be designated as ‘intra-nuclear foci-positive’ a minimum intensity threshold had to be present in at least one plane. In the 3D-catFISH program, prior to determining concordance with human observers, the foci size default threshold was adjusted down if a visual check revealed that the program excluded the smallest “true” foci. The adjusted threshold was held constant for all the image stacks from that group. For a cell to be designated as ‘cytoplasmic positive’, peri-nuclear labeling over at least three planes was required, with the signal spread across 75% of the nuclear circumference in at least two planes. Fifteen image stacks were analyzed from the CA1 region of hippocampus and 12 stacks were from the parietal cortex. Three separate experts manually rated each of these stacks for numbers of negative nuclei (without any IEG RNA labeling), nuclei that contained FISH signal, and cells that contained cytoplasmic FISH signal. Statistical analysis was done using a “consensus count” established by the three experts after they had individually analyzed the data. Nuclei were manually selected by each of the individual experts using MetaMorph image analysis software. A “consensus count” of nuclei classiﬁcation was then determined. Statistical comparisons between the “consensus counts”, automated program and manual counts were done using Microsoft Excel and Statview analysis packages.

22

M.K. Chawla et al. / Journal of Neuroscience Methods 139 (2004) 13–24

3. Results The accuracy of the automated image analysis software was evaluated with respect to three variables: (1) accuracy of the software to segment nuclei, (2) accuracy of the software to classify intranuclear foci and (3) accuracy of classifying cytoplasmic FISH signal. The accuracy of the automated segmentation analysis was evaluated for the presence of hyper-segmented and under-segmented cells as shown in Table 3. In both regions the mean percent of segmentation errors (clusters and hyper-segmented nuclei) was quite low. Following segmentation, the image stacks were rated for the presence or absence of ﬂuorescence in the nucleus and cytoplasm for each cell. Table 4 contains the compar-

Table 3 An evaluation of the segmentation performance of three-dimentionalcatFISH was accomplished using unedited automated (raw) percentage of clusters (deﬁned as a group of nuclei or glia erroneously taken as one nucleus by the program) and hyper-segmented nuclei (where the program erroneously deﬁnes multiple nuclei where only one nucleus is actually present) in two brain regions, hippocampus and parietal cortex. Manual editing of the automated results eliminated all the hyper-segmented nuclei and decreased the number of clusters Raw CA1 Total nuclei analyzed Mean clusters (%) Mean hypersegmented nuclei (%) Parietal cortex Total nuclei analyzed Mean clusters (%) Mean hypersegmented nuclei (%) 863 2.8 0.9 858 4.7 1 Edited 919 1.2 0 791 2 0

Table 4 FISH classiﬁcation (both intra-nuclear and cytoplasmic) results were compared using data obtained by the three experts and 3D-catFISH with the consensus counts. Only nuclei that were common among the comparisons were chosen for analysis. Mean mismatches (%) with consensus counts (classiﬁcation of nuclei agreed upon by the three experts) were quite low for all the experts and the 3D-catFISH (1–8%) in both the hippocampus and parietal cortex Expert 1 Expert 2 Expert 3 3D-catFISH CA1 Intranuclear classiﬁcation Total shared nuclei 431 Mean mismatches (%) 5 Cytoplasmic classiﬁcation Total shared nuclei 390 Mean mismatches (%) 4 Parietal cortex Intranuclear classiﬁcation Total shared nuclei 293 Mean mismatches (%) 1 Cytoplasmic classiﬁcation Total shared nuclei 319 Mean mismatches (%) 1

ison of each of the human experts (1, 2 or 3) and the automated software measurements with the consensus counts, for cells segmented in hippocampal CA1 and the parietal cortex of the rat. The top line of the table for each region indicates the total number of nuclei counted by each expert and by the automated software system. The lines in Table 4 labeled “mismatches” indicate the mean percent of classiﬁcation mismatches between the consensus count, each expert and the software measurements. Only nuclei that were common (shared) among the comparisons were chosen for analysis. Note the low percentage of mismatches between the consensus counts and each of the expert’s counts as well as between the consensus counts and the software for intra-nuclear and cytoplasmic FISH classiﬁcation in both CA1 and parietal cortex. Analysis using 3D-catFISH resulted in higher percentage mismatches for the cytoplasmic classiﬁcation in both CA1 and Parietal cortex. For the CA1 region, the high packing density of pyramidal cells makes it difﬁcult to separate overlapping cytoplasmic signals. For the parietal cortex, on the other hand, the cytoplasmic signal is generally more diffuse and located further from the nucleus. This may lead to increased sampling error. Regression plots of the classiﬁcation results of 3D-catFISH (x-axis) versus concensus counts (y-axis) for each confocal image stack reveals a high degree of correlation for intra-nuclear foci and cytoplasmic FISH signals. As shown in Fig. 5 the correlation coefﬁcients were >0.98 for all the comparisons. Data (%) for the foci series included all four categories, i.e., nuclei with no labeling, nuclei with positive Arc labeling, nuclei with positive Homer 1a labeling and nuclei containing both Arc and Homer 1a labeling. Fig. 5A represents data from hippocampal CA1 region and Fig. 5C is from the parietal cortex, R2 = 0.98 and 0.99, respectively). Data (%) for the cytoplasmic series included cells that were negative for cytoplasmic Arc and those that were positive for cytoplasmic Arc (Fig. 5B and D are from the cytoplasmic series of CA1 and parietal cortex with R2 = 0.99 and 0.99, respectively).

4. Discussion In the present study, we have developed and validated an automated software system for segmenting neuronal nuclei and quantifying cellular distributions of I EG transcription products using confocal images from hippocampus and parietal cortex. The validation results conﬁrm that our goal of achieving maximum automation while maintaining accuracy is at least comparable to manual scoring by human experts. Our approach has important advantages over the manual counting methods in that, with minimum editing, 3D-catFISH can automatically provide a much faster, less tedious, and more objective means of measuring cellular ﬂuorescence labeling. These features can enable efﬁcient processing of large data sets.

456 5 411 5

452 5 420 3

468 1 417 8

280 3 318 3

278 2 304 1

294 1 328 4

M.K. Chawla et al. / Journal of Neuroscience Methods 139 (2004) 13–24

23

Many applications in neurobiology require accurate segmentation of cell nuclei for analysis. Methods that are currently available utilize a rule-based learning method (Adiga and Chaudhuri, 2001). The approach we have used in the current study is a model-based watershed breaker scheme that is clearly superior (Lin et al., 2003). Segmentation using rule-based merging methods requires a user- speciﬁed cell size threshold parameter only, whereas, the 3D-catFISH program utilizes a variety of cell features such as intensity, shape, as well as cell size. Errors due to small cells touching each other or big cells that are fragmented but are above the size threshold can be eliminated with our approach. Extraction of quantitative ﬂuorescence data from confocal images can be challenging. It requires proper specimen preparation so that ﬂuorescence-tagged gene probes provide speciﬁc labeling with maximal signal-to-noise ratio. Therefore, acquisition of confocal images requires careful selection of parameters so that the signal is speciﬁc to a particular cell compartment with minimum background, auto-ﬂuorescence or photobleaching. Lastly, manual analysis of these images can be daunting and time consuming, as it is limited by inherent problems such as operator variability due to differences in sensitivity to detect different colors and their intensities, as well as differences between computer monitor display capabilities that can contribute to errors. We have shown in the present study that it is possible, with minimal user intervention, to segment cell nuclei, eliminate glial/non-neuronal cells, and analyze and classify FISH signals inside the nucleus as well as in the cytoplasm of cells. The cytoplasmic signal proved more challenging compared to foci classiﬁcation (see Table 4). Due to the higher packing density of pyramidal cells in the CA1 region, it is possible that the software had problems separating the cytoplasmic signal between cells. In the parietal cortex a different type of challenge was encountered i.e. the cytoplasmic signal was spread out further from the nucleus and possibly escaped detection by 3D-catFISH. We have since then corrected this problem by allowing more ﬂexibility in deﬁning the region of cytoplasmic signal. The comparison of manual consensus counts with 3D-catFISH counts (automated) for intra-nuclear foci and cytoplasmic FISH signals (see Fig. 5 for correlation coefﬁcients >0.98) revealed a high degree of correlation in both hippocampal CA1 and parietal cortex. There is a great need for automated data processing for the advancement of our understanding the neural basis of behavior and cognition. Present methodology is limited in that only small regions of the brain can be analyzed due to the time consuming nature of tissue processing, image acquisition and image analysis. Since image analysis has proven to be the most time consuming in this process, computer software that will automate the segmentation of nuclei and measure the subcellular FISH signals can greatly speed up its application in measuring IEG-based neural activity for large brain areas. Presently, our images usually contain three color channels, i.e., one nuclear and two FISH channels. We are currently exploring in situ hybridization parameters and

computer algorithms to handle hyperspectral confocal images with more color channels. The computer algorithms for the automated image analysis presented here will have to undergo a number of modiﬁcations for large-scale brain behavior and cognition studies. These kinds of studies provide a logical progression for improving our understanding of functional brain circuitry. There are a number of productive directions for future development underway. These include the exploration of effective batch processing methods that decrease the need for manual supervision, expansion of the number of ﬂuorophores that can be assessed simultaneously and development of boundary overlap recognition methods for merging multiple confocal images automatically.

Acknowledgements This work was supported by the National Institutes of Health grant numbers AG18230 and AG09219.

References
Adiga U, Chaudhuri BB. An efﬁcient method based on watershed and rule-based merging for segmentation of 3D histo-pathological images. Pattern Recognit 2001;34:1449–58. Barnes CA, Suster MS, Shen J, McNaughton BL. Multistability of cognitive maps in the hippocampus of old rats. Nature 1997;388:272–5. Borgefors G. Distance transformations in digital images. Comput Vision, Graphics Image Process 1986;34:344–71. Bottai D, Guzowski JF, Schwarz MK, Kang SH, Xiao B, Lanahan A, et al. Synaptic activity-induced conversion of intronic to exonic sequence in Homer 1 immediate early gene expression. J Neurosc 2002;22:167–75. Gothard KM, Skaggs WE, Moore KM, McNaughton BL. Binding of hippocampal CA1 neural activity to multiple reference frames in a landmark-based navigation task. J Neurosci 1996;16:823–35. Guzowski JF, McNaughton BL, Barnes CA, Worley PF. Environmentspeciﬁc expression of the immediate-early gene Arc in hippocampal neuronal ensembles. Nature Neurosci 1999;2:1120–4. Guzowski JF, McNaughton BL, Barnes CA, Worley PF. Imaging neural activity with temporal and cellular resolution using FISH. Curr Opin Neurobiol 2001;11:579–84. Hoffman KL, McNaughton BL. Coordinated reactivation of distributed memory traces in primate neocortex. Science 2002;297:2070–3. Holmesf TJ, Bhattacharyya S, Cooper JA, Hanzel D, Krishnamurthi V, Roysam B, et al. Light microscopic images reconstructed by maximum likelihood deconvolution. In: Pawley J, editor. Handbook of confocal microscopy. New York: Plenum Press; 1995. Lin G, Adiga U, Olson K, Guzowski JF, Barnes CA, Roysam B. A hybrid three-dimensiona; watershed algorithm incorporating gradient cues and object models for automatic segmentation of nuclei in confocal image stacks. Cytometry 2003;56A:23–6. Lyford GL, Yamagata K, Kaufmann WE, Barnes CA, Sanders LK, Copeland NG, et al. Arc, a growth factor and activity-regulated gene, encodes a novel cytoskeleton-associated protein that is enriched in neuronal dendrites. Neuron 1995;14:433–45. Mackin Jr RW, Newton LM, Turner JN, Roysam B. Advances in high-speed, three-dimensional imaging and automated segmentation algorithms for thick and overlapped clusters in cytologic preparations, application to cervical smears. Anal Quant Cytol Histol 1998;20: 105–21.

24

M.K. Chawla et al. / Journal of Neuroscience Methods 139 (2004) 13–24 immediate-early genes arc and Homer 1a in hippocampal and neocortical neuronal networks. J Neurosci 2002;22:10067–71. Vazdarjanova A, Ramirez-Amaya V, Sutherland VL, Chawla MK, Worley PF, Barnes CA, et al. Behavior induces expression of the plasticity-related immediate-early gene Arc in excitatory hippocampal and cortical neurons, but not in astrocytes or inhibitory neurons. Abstract viewer; online. Program number 519.7. Soc Neurosci 2003. Wilson MA, McNaughton BL. Dynamics of the hippocampal ensemble code for space. Science 1993;261:1055–8.

Nicolelis MA, Dimitrov D, Carmena JM, Crist R, Lehew G, Kralik JD, et al. Chronic, multisite, multielectrode recordings in macaque monkeys. Proc Natl Acad Sci USA 2003;100:11041–6. Nicolelis MAL, Ghazanfar AA, Faggin BM, Votaw S, Oliveira LMO. Reconstructing the engram: stimultaneous, multisite, many single neuron recordings. Neuron 1997;18:529–39. Theodoridis S, Koutroumbas K. Pattern recognition: Academic Press; 1999. Vazdarjanova A, McNaughton BL, Barnes CA, Worley PF, Guzowski JF. Experience-dependent coincident expression of the effector

