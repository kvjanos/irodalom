Original Article

3D Image Stack Reconstruction in Live Cell Microscopy of Drosophila Muscles and its Validation
Tiehua Du,1* Martin Wasser1,2*
 Abstract Rapid movements of live tissues during the acquisition of 3D image stacks can result in misalignments between successive image slices. The remodeling of the muscles in Drosophila metamorphosis is an example where sporadic motion during image acquisition impede image analysis and volume visualization. Most of the image stack registration algorithms applied in microscopy are aimed at the linear alignment of fixed histological sections. However, live muscles are nonrigid objects and their contractions and relaxations represent nonlinear transformations that cannot be properly rectified by applying purely linear registration methods. We developed a fully automated area-based nonrigid stack registration (NSR) method that minimizes the mean square error of intensities between successive image slices. The mapping function is formulated using the thin plate spline (TPS). A hierarchical linear to nonlinear, coarse to fine matching strategy is applied to ensure stability and fast convergence. Topological structure is preserved by constraining the step size of the nonlinear transformation. To assess the accuracy of 3D reconstruction, we propose a new benchmarking method that measures geometrical features of restored nuclei. We tested our algorithm on image stacks generated by laser scanning confocal microscopy that show live muscles during the prepupal stage of Drosophila metamorphosis. Our registration algorithm is able to restore image stacks that are distorted by periodic contraction of muscles. Quantitative assessment of registration performance agrees well with qualitative visual inspection. Our NSR method is able to restore image stacks for the purpose of visualization and quantitative analysis of Drosophila metamorphosis and, potentially, various other processes in developmental biology studied by 3D live cell microscopy. ' 2009 International Society for Advancement of Cytometry  Key terms live cell imaging; confocal microscopy; 3D reconstruction; nonrigid registration; thin plate spline; Drosophila; muscle development; metamorphosis

1

Bioinformatics Institute (BII), Agency for Science, Technology and Research, (A*STAR), Singapore 138671 Department of Biological Sciences, National University of Singapore, Republic of Singapore

2

Received 29 August 2008; Revision Received 3 November 2008; Accepted 2 December 2008 Additional Supporting Information may be found in the online version of this article. *Correspondence to: Tiehua Du or Martin Wasser, Bioinformatics Institute (BII), Agency for Science, Technology and Research, (A*STAR), 30 Biopolis Street #07-01, Matrix Building, Singapore 138671 Email: duth@bii.a-star.edu.sg or martinw@bii.a-star.edu.sg Published online 7 January 2009 in Wiley InterScience (www.interscience. wiley.com) DOI: 10.1002/cyto.a.20701 © 2009 International Society for Advancement of Cytometry

IN the areas of developmental and cell biology, multidimensional imaging of living tissues has gained increasing popularity as a tool to study and visualize the diversity of cellular functions and behaviors. The progress in live cell imaging is driven by two principal technologies: the development of fluorescent proteins and improvement in instrumentation. Ever since the discovery of the green fluorescent protein (GFP) from the jellyfish Aequorea (1), various studies have demonstrated that GFP, its variants and many other fluorophores from other (mostly marine) animals can be functionally tagged to almost any other protein (2,3). Through genetic engineering it is possible to control multiple aspects of reporter gene expression, including cell type, sub-cellular localization, time and strength, and the color of the fluorophore. Confocal laser scanning microscopy (CLSM) is the most common imaging modality to visualize fluorescently labeled cells in animal models, such as zebrafish, Caenorhabditis elegans and Drosophila. Because of its ability to remove out-of-focus light, it is better suited for optical sectioning of intact, multilayered tissues than wide-field fluorescence microscopy (4). However, traditional CLSM has the disadvantage of slower acquisition as the image is scanned pixel by pixel. Two technologies currently
Cytometry Part A  75A: 329À343, 2009

ORIGINAL ARTICLE
available help to increase acquisition speed: Spinning disk CLSM systems allow many spots of the field of view to be illuminated simultaneously (5) and line-scanning CLSMs employ a slit aperture instead of a pinhole and, thus, can scan an entire line simultaneously (6). Recently, even faster, though commercially not yet available live cell imaging systems have been reported. These include selective plane illumination microscopy (SPIM) (7) and digital scanned laser light sheet fluorescence microscopy (DSLM) (8). Metamorphosis refers to the phase in insect development that converts the larval into the adult body plan (9). The transformation involves the destruction of obsolete larval tissues, the generation of new adult tissues and the remodeling of larval into adult tissues. Thanks to fluorescent proteins and a transparent cuticle, various events in Drosophila metamorphosis can be visualized by noninvasive live cell imaging. Apoptosis and morphogenic movements have been monitored using tissue specific expression of a GFP reporter (10). The Fluorescence resonance energy transfer (FRET)-based caspases-3 indicator has been used to visualize apoptosis in salivary glands (11). In the muscular system, most muscle cells are histolyzed and replaced by adult cells. A small fraction of muscle fibers survives and acquires a new function in adults. For instance, the external oblique muscles of the abdomen persist to become temporary muscles that are required for the eclosion of the pharate adult (12). Using muscle specific reporters, the entire remodeling process can be monitored in vivo, which makes it feasible to study cellular processes at high resolution and characterize the function of genes involved in these processes (13). Rapid movements of live tissues in the course of image acquisition can severely affect the ability to analyze and visualize multidimensional image data. The twitching of muscles can be silenced by anesthetizing the specimen (14) but this is not always a practical solution. In contrast to the medical imaging field, only a relatively small number of studies have applied image registration to biological time-lapse images (15). To track leukocytes in the vasculature of mice, a registration method has been proposed that stabilizes jitter caused by circulatory and respiratory movements (16). The 4D reconstruction of the beating heart in zebrafish embryos has been achieved using a wavelet-based synchronization approach (17). Image registration is an important branch in computer vision that deals with establishing correspondence between different images acquired at different times, using different modalities and from different perspectives. A comprehensive literature survey of image registration methods can be found in Brown (18) and Zitova and Flusser (19). Image registration algorithms can be categorized into linear and nonlinear approaches based on the mapping functions between reference and target images. Linear image registration approaches (20– 23) assume that the objects in the images are rigid. Their mapping functions include similarity transformation, affine transformation and perspective projection. Goshtasby (24) proved that linear transformation mapping cannot achieve accurate registration of images with local distortions. Many nonlinear
330

image registration methods have been reported. Elastic registration approach introduced by Bajcsy et al. (25) considers images as pieces of rubber sheets that are brought into alignment by external forces with minimal bending and stretching. Multiquadrics, reciprocal multiquadrics, Gaussians, Wendland’s functions, and thin-plate splines (TPS) are several examples of the radial basis functions used in image registration to handle locally varying geometric distortions (26–31). Previous studies that compared the performance of the TPS and other mapping functions concluded that TPS possesses favorable properties when used for image registration, and also yields better registration results (26,32,33). Image registration methods can be further categorized into feature- and area-based approaches. Feature-based methods (26,27,31,34) generally extract sets of feature points (e.g. end points, center of lines, and center of regions) from reference and target images, and then find the correspondences using their spatial relationships or other correlations. In contrast, area-based approaches do not attempt to detect any salient features in images. The distinctive information is provided by intensities or colors rather than by local shapes or structures. Area-based approaches can be categorized into three classes: correlationlike methods, Fourier methods and mutual information methods (19). Correlation-like approaches (35–37) are classical representatives of area-based methods and aim to maximize the similarity between reference and target image. A drawback is that computational load can grow very fast with an increase in transformation complexity. Fourier methods (38,39) perform registration of frequency representations of images. Fourier methods are often preferred over correlation-like approaches since registration in the frequency domain can be faster and more robust to noise contamination. Mutual information (MI) methods (40–42) are based on the maximization of MI, a measure of the statistical dependency between two data sets. They tend to be more suitable for multimodality image registration. Evaluating the accuracy of image registration algorithms is a prerequisite for their utilization in practical image restoration problems (19). Although a substantial amount of work has been directed at the validation of rigid-body registration (43) there is a lack of quantitative methods that evaluate the accuracy of nonlinear and nonrigid registration algorithms (44). In this study, we developed a fully automated 3D image stack restoration method for the correction of image misalignments in live-cell microscopy. The area-based nonrigid registration algorithm aims to minimize the mean square error of pixel intensities between successive images by optimizing the TPS mapping function. The method was successfully applied to the restoration image stacks that show apoptotic muscles in the early stage of Drosophila metamorphosis.

MATERIALS AND METHODS
The work described here consists of three main parts: (1) 3D time-lapse imaging of Drosophila metamorphosis, (2) the image stack registration algorithm, and (3) the methodology for assessing the accuracy of image alignment (Fig. 1A).
3D Reconstruction of Live Muscles

ORIGINAL ARTICLE

Figure 1. (A) Workflow of image stack restoration and validation. (B) Flow diagram of nonrigid 3D image stack reconstruction algorithm. (C) Preservation of image topology by constraining the warping of control points.

Sample Preparation and Image Acquisition To label Drosophila muscle cells in vivo we used the muscle specific reporter MHC-tauGFP (45). Co-expression of the nuclear marker Histone H2B-RFP was achieved using the UAS-GAL4 system (46), with the mesoderm specific driver 24B-Gal4 activating the expression of UAS::H2B-mRFP (47).
Cytometry Part A  75A: 329À343, 2009

White pupae of triple transgenic flies were collected with a soft brush, transferred to a 1.5-mm glass-bottom dish (MatTek), immersed into lens oil (Zeiss) and oriented with the dorsal side facing down. The side of the glass bottom dish was lined with wet tissue paper to keep the chamber moist. Lens oil did not appear to affect viability. White pupae
331

ORIGINAL ARTICLE
immersed in lens oil survived for at least 3 days as they developed into pharate adults. In contrast, prepupae embedded in 1% low melting point agarose entered developmental arrest in less than an hour and never reached the pupal stage. We chose not to incubate pupae in water or saline solution as the specimen tended to float and roll sideways. Live imaging of prepupal muscles was performed on a high-speed, line scanning Zeiss 5 Live confocal laser scanning inverted microscope (6) using a dry 203/0.5 Plan-Neofluar objective. The 3D stacks were recorded at 2-minute intervals over a 60-minute period at an x/y/z scaling of 0.67 3 0.67 3 2.2 lm3. Because of the differences in refractive index between air and the mounting medium (lens oil) depth measurements were multiplied by a correction factor of 1.51 (48). Hence distances between sections were assumed to be 3.3 lm. Each image stack consisted of 29 dual-channel optical sections that were acquired at intervals of approximately 1.5 seconds. The two channels corresponding to GFP and RFP were recorded sequentially at an acquisition rate of 0.5 seconds per image of 1024 3 1024 pixels. We used the following combinations of excitation wave length and emission filter: 489 nm and 500– 525 nm band path filter for GFP, 532 nm and 560–675 nm band path filter for RFP. To compensate for the attenuation of detected fluorescence signals with increasing depth we applied the Auto-Z function of the Zeiss acquisition software. Uniform brightness distribution was achieved by gradually increasing the power of the 489 nm laser from 5–7% and that of the 532 nm laser from 14–16%.
Nonrigid Area-Based Registration To facilitate the reconstruction of 3D image stacks we developed an area-based nonrigid stack reconstruction (NSR) algorithm. The flow diagram is shown in Figure 1B.

E¼

Z Z
X

ððI1 R ðx; yÞ À aI2 R ðu; vÞ À bÞ2 þ ðI1 G ðx; yÞ À aI2 G ðu; vÞ À bÞ2 Þdxdy ð2Þ

For the sake of generalization, the equations derived in the following sections are based on the cost function in Eq. (1) for single channel mapping, which can be easily extended to two or more channels. Thin plate spline mapping function. TPS, derived from a physical analogy involving the bending of a thin sheet of metal, was first introduced to image processing by Bookstein (49). Among all possible mapping functions, TPS requires the least bending energy to pass through a set of given target control points (49). Extensive studies (26,32,33) comparing the performance of TPS with other mapping functions, such as polynomial, multiquadrics, and Gaussian radial basis function, concluded that the TPS has favorable properties when used for image registration (19). Because of the reasons mentioned above, we chose TPS as the mapping function according to Eq. (3). u ¼ au1 þ aux x þ auy y þ v ¼ av1 þ avx x þ avy y þ
n X i¼1 n X i¼1

wui U ðjP i À ðx; yÞjÞ ð3Þ

wvi U ðjP i À ðx; yÞjÞ

where (au1, aux, auy, wui, av1, avx, avy, wvi) are the coefficients of TPS functions (49), U (|Pi 2 (x,y)|) is the TPS kernel function defined as: U ðjP i À ðx; yÞjÞ ¼ ðjP i À ðx; yÞjÞ2 logðjP i À ðx; yÞjÞ2 À Á À Á ¼ ðPix À xÞ2 þ ðPiy À yÞ2 log ðPix À xÞ2 þ ðPiy À yÞ2 ð4Þ Pi is the set of control points (P1x, P1y), . . . (Pnx, Pny) in the source image. These source control points determine the positions of the TPS kernel functions that help to correct local distortions. In this study, we assigned these source control points to the intersections of grid lines with a uniform spacing of 75 pixels which correspond to 50.25 lm. We tested a range of values between 30 and 150 pixels and judged 75 to produce the best reconstruction of nuclei. If the number of control points was too low, the TPS was not flexible enough to establish a good mapping between source and target images. However, too many control points increased computational time and memory requirements without improving alignment accuracy. Linear registration. Initially, we tried to optimize all TPS parameters (au1, aux, auy, wui, av1, avx, avy, wvi) simultaneously. However, unexpected warping of the target relative to the reference image often resulted in poor alignment. To overcome this, we first perform linear alignment on two images before carrying out nonlinear deformations. At this stage, we only updated the parameters of the first three terms of the two TPS functions in Eq. (3) au1, aux, auy, av1, avx and avy, which were
3D Reconstruction of Live Muscles

Cost function. Adjacent optical sections captured by CLSM display significant similarities in both structure and intensity. Therefore, the mean square error of intensities between two adjacent images should be minimal if they are properly aligned. On the basis of this assumption, the image registration problem can be formulated as a minimization problem. The mapping function u(x,y), v(x,y) is optimized to minimize the cost function shown in Eq. (1): E¼ Z Z
X

ðI1 ðx; yÞ À aI2 ðu; vÞ À bÞ2 dxdy

ð1Þ

The coordinates of image I2, (u,v), are functions of the image coordinates of I1, (x,y). O is a user-defined square region which is slightly smaller than the original image to ensure the counterpart of region O in I1 exists in I2. Parameters a and b are used to compensate for decreasing light intensity in deeper sections. Images of live prepupae consisted of two channels: a green channel showing the cytoplasm of muscles and a red channel showing the nuclei. Registration was performed in two ways: either using red or green channel alone according to Eq. (1) or using both channels combined according to Eq. (2):
332

ORIGINAL ARTICLE
initialized as 0, 1, 0, 0, 0, and 1, respectively, for identical mapping. They were updated iteratively following the negative direction of the partial differential of E with respect to each parameter until function E converges at an equilibrium point using Eqs. (5) and (6). Z Z @E @I2 ðI1 À aI2 À bÞ ¼ À2a dxdy @au1 @u X Z Z @E @I2 xdxdy ¼ À2a ðI1 À aI2 À bÞ @aux @u X Z Z @E @I2 ðI1 À aI2 À bÞ ¼ À2a ydxdy @auy @u X Z Z ð5Þ @E @I2 dxdy ¼ À2a ðI1 À aI2 À bÞ @av1 @v X Z Z @E @I2 ðI1 À aI2 À bÞ ¼ À2a xdxdy @avx @v X Z Z @E @I2 ydxdy ¼ À2a ðI1 À aI2 À bÞ @avy @v
X

@E ¼ À2a @Tiu

Z Z
X

ðI1 À aI2 À bÞ

@I2 @u
n X i¼1

À1 À1 À1 3 Lnþ1;k þ Lnþ2;k x þ Lnþ3;k y þ

! À1 Li;k Ui dxdy

@E ¼ À2a @Tiv

Z Z
X

@I2 ðI1 À aI2 À bÞ @v
À1 Lnþ1;k

3

þ

À1 Lnþ2;k x

þ

À1 Lnþ3;k y

þ

n X i¼1

À1 Li;k Ui

! dxdy ð9Þ

where L21 is the (n 1 1, k) element of matrix L21. L21 is n11,k the inverse of matrix L. L is the source control points matrix defined as: ! K P ð10Þ L¼ PT 0 Matrices P and K are defined as: 2 1 P1x 6 1 P2x P¼6 4... ... 1 Pnx 0 U ðr12 Þ 6 U ðr21 Þ 0 6 K ¼4 ÁÁÁ ÁÁÁ U ðrn1 Þ U ðrn2 Þ 2

tþ1 t au1 ¼ au1 À g1 tþ1 aux tþ1 auy tþ1 av1 tþ1 avx tþ1 avy

@E @au1 @E t ¼ aux À g1 @aux @E t ¼ auy À g1 @auy @E t ¼ av1 À g1 @av1 @E t ¼ avx À g1 @avx @E t ¼ avy À g1 @avy

3 P1y P2x 7 7 ... 5 Pnx ÁÁÁ ÁÁÁ ÁÁÁ ÁÁÁ 3 U ðr1n Þ U ðr2n Þ 7 7 ÁÁÁ 5 0

ð11Þ

ð12Þ

ð6Þ

where rij is the distance between two control points Pi and Pj qﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃﬃ defined as ðPix À Pjx Þ2 þ ðPiy À Pjy Þ2 . The parameters au1, aux, auy, wui, av1, avx, avy, wvi can be calculated with given target control points using: ðwu1 ; . . . ; wun ; au1 ; aux ; auy ÞT ¼ L À1 Yu ðwv1 ; . . . ; wvn ; av1 ; avx ; avy ÞT ¼ L À1 Yv ð13Þ

Nonlinear registration. After linear transformation, we proceeded to optimize the nonlinear parameters of the TPS. Unlike the previous linear alignment, we did not directly update the parameters wui and wvi since varying parameters wui or wvi globally affected the TPS function, thus preventing appropriate local deformations and resulting in slow convergence. Instead, we updated the target control points because shifting a target control point only impacts the points in the local neighborhood. The target control points (Tiu, Tiv) were initialized based on the linear transformation obtained from the primary alignment using Eq. (7) Tiu ¼ au1 þ aux Pix þ auy Piy Tiv ¼ av1 þ avx Pix þ avy Piy ð7Þ

where Yu and Yv are vectors constructed with target control points Yu ¼ ðT1u ; . . . ; Tnu ; 0; 0; 0ÞT Yv ¼ ðT1v ; . . . ; Tnv ; 0; 0; 0ÞT ð14Þ

The target control points are then updated using gradient descent method according to Eqs. (8) and (9).
tþ1 t Tiu ¼ Tiu À g2 @E=@Tiu tþ1 t Tiv ¼ Tiv À g2 @E=@Tiv

ð8Þ

Preservation of topology. To avoid unexpected warping during nonlinear transformation it is essential to preserve the topology of the target image. Preservation of topology can be enforced by ensuring the positivity of the Jacobian matrix Ju,v at each iteration (50–52). However, calculating the determinant of the Jacobian matrix of every pixel at each iteration is computationally very expensive, and hence, impractical. Therefore, we introduced a constraint, which maintains the positivity of the Jacobian matrix while updating the target control points.
333

Cytometry Part A  75A: 329À343, 2009

ORIGINAL ARTICLE
The Jacobian matrix at target control point Tj,k can be written as:    @u ðTj;k Þ @u ðTj;k Þ   @x  @y ð15Þ Ju;v ðTj;k Þ ¼  @v   @x ðTj;k Þ @v ðTj;k Þ  @y Here, Tj,k is the target control point in a matrix form which represents the neighborhood relationship in the spatial domain. TjÆ1,kÆ1 are its immediate neighboring control points. The forward and backward partial derivative of u and v with respect to x and y at control point Tj,k can be approximated as: @u ðTj;k Þf ¼ Tðjþ1;kÞu À Tðj;kÞu @x @u ðTj;k Þb ¼ Tðj;kÞu À TðjÀ1;kÞu @x @u ðTj;k Þf ¼ Tðj;kþ1Þu À Tðj;kÞu @y @u ðTj;k Þb ¼ Tðj;kÞu À Tðj;kÀ1Þu @y @v ðTj;k Þf ¼ Tðjþ1;kÞv À Tðj;kÞv @x @v ðTj;k Þb ¼ Tðj;kÞv À TðjÀ1;kÞv @x @v ðTj;k Þf ¼ Tðj;kþ1Þv À Tðj;kÞv @y @v ðTj;k Þb ¼ Tðj;kÞv À Tðj;kÀ1Þv @y By substituting Eq. (16) into Eq. (15), the determinant of Jacobian matrix at point Tj,k can be approximated as Eq. (17), and they must be greater than zero to preserve topology. J ðTj;k Þff ¼ ðTðjþ1;kÞu À Tðj;kÞu ÞðTðj;kþ1Þv À Tðj;kÞv Þ À ðTðj;kþ1Þu À Tðj;kÞu ÞðTðjþ1;kÞv À Tðj;kÞv Þ > 0 J ðTj;k Þ ¼ ðTðjþ1;kÞu À Tðj;kÞu ÞðTðj;kÞv À Tðj;kÀ1Þv Þ À ðTðj;kþ1Þu À Tðj;kÞu ÞðTðj;kÞv À TðjÀ1;kÞv Þ > 0 J ðTj;k Þ ¼ ðTðj;kÞu À TðjÀ1;kÞu ÞðTðj;kþ1Þv À Tðj;kÞv Þ À ðTðj;kÞu À Tðj;kÀ1Þu ÞðTðjþ1;kÞv À Tðj;kÞv Þ > 0 J ðTj;k Þ ¼ ðTðj;kÞu À TðjÀ1;kÞu ÞðTðj;kÞv À Tðj;kÀ1Þv Þ À ðTðj;kÞu À Tðj;kÀ1Þu ÞðTðj;kÞv À TðjÀ1;kÞv Þ > 0 ð17Þ
bb bf fb

ð16Þ

These four inequalities ensure the topological structure of the four triangles formed by Tj,k and the two neighboring control points, e.g. the triangle formed by (Tj,k, Tj,k21, Tj11,k), (Tj,k, Tj11,k, Tj,k11), (Tj,k, Tj,k11, Tj21,k), and (Tj,k, Tj21,k, Tj,k21,) as shown in Figure 1C. In fact, we only need to solve one of the four inequalities in Eq. (17) since the updating direction is known and given by (@E/@T(j,k)u, @E/@T(j,k)v). For instance, if the vector (@E/@T(j,k)u, @E/@T(j,k)v) points to line (Tj11,k, Tj,k11) then we will only need to consider the triangle (Tj,k, Tj11,k Tj,k11) where the constraint is imposed by the first inequality in Eq. (17). By substituting Eq. (8) into the first inequality in Eq. (17), we can obtain the constraint of step size g2:

g2 <

Tðj;kÞu ðTðjþ1;kÞv À Tðj;kþ1Þv Þ þ Tðj;kÞv ðTðj;kþ1Þu À Tðjþ1;kÞu Þ þ Tðjþ1;kÞu Tðj;kþ1Þv À Tðjþ1;kÞv Tðj;kþ1Þu @E=@Tðj;kÞu ðTðjþ1;kÞv À Tðj;kþ1Þv Þ þ @E=@Tðj;kÞv ðTðj;kþ1Þu À Tðjþ1;kÞu Þ

ð18Þ

If the vector (@E/@T(j,k)u, @E/@T(j,k)v) points to any of the other three lines, the constraint of updating step size g2 can be obtained similarly by substituting Eq. (8) into the other three inequalities in Eq. (17). Whenever we update a target control point Tj,k, we compute the constraint of the updating step size according to Eq. (18). When the default constant step size g0 2 satisfies the constraint shown in Eq. (18) then Tj,k is updated using step size g0 2, otherwise the step size will be reduced to half the upper bound of the constraint. In theory, this simplification only guarantees topology preservation for the control points. However, in practice, since the TPS is a smooth function, it reduces computational load while preserving topological structure of the image. Intensity compensation. In optical sections acquired by CLSM, the intensity of the emitted fluorescence decreases with deeper tissue penetration. As a result, sections near the surface appear brighter than those in the interior of the tissues. For serial sections acquired with constant laser power, the intensity distribution showed an approximately linear decline up to a depth of 100 lm (Supp. Fig. 1A). Hence, for simplicity, we
334

assume that intensity differences are uniform and linear, and add two parameters a and b to compensate for the light decay. We initialize a and b at 1 and 0, respectively, then update them using the partial differential equation of E with respect to a and b as shown in Eqs. (19) and (20). a and b can be updated simultaneously with the linear and nonlinear transformation optimization mentioned above. @E=@a ¼ À2 @E=@b ¼ À2 Z Z
X Z Z

ðI1 À aI2 À bÞI2 dxdy ð19Þ ðI1 À aI2 À bÞdxdy

X

atþ1 ¼ at À g3 b
tþ1

@E @a @E ¼ bt À g3 @b

ð20Þ

In the experiments described here, we gradually increased laser power with increasing depth to achieve a uniform signal
3D Reconstruction of Live Muscles

ORIGINAL ARTICLE
distribution (Supp. Fig. 1B). Hence, when there is no intensity attenuation, a becomes 1 and b becomes 0. Sequential Gaussian filtering. Gradient descent approaches like the one described above have the tendency to be trapped in local minima due to alignment of noncorresponding local features at fine resolution. To alleviate this problem, we performed a coarse to fine registration which consists of four rounds of registration. In the first three rounds, prior to registration, we convolved reference and target images with Gaussian filters of decreasing smoothing factors r of 8, 4, and 2. This helps to emphasize large structures at the expense of fine detail. In the final round, no smoothing filter was applied. The parameters au1, aux, auy, wui, av1, avx, avy, wvi obtained from a previous round of registration were used to initialize the subsequent registration. This strategy of sequential low-pass filtering achieved improved registration accuracy. Image stack restoration. After obtaining the TPS transformation functions for all adjacent pairs of optical sections, all image slices are sequentially transformed to achieve alignment with respect to the middle slice to keep displacements as small as possible. For instance, for a stack of 29 sections, alignments of sections 1–14 and 16–29 are performed using slice 15 as reference. We denote the transformation between image slices m u and m 1 1 as u 5 fu m,m11 (x, y) and v 5 f m,m11 (x, y). The transformations between any image to the reference slice are obtained iteratively using Eqs. (21) or (22). The transformation functions are used to establish correspondence between pixels in reference and target images. As pixel coordinates are calculated at subpixel accuracy, their intensity values are determined by linear interpolation
u u u v um ¼ fm;mþ1 ðÁ Á Á ðf13;14 ðf14;15 ðx; yÞ; f14;15 ðx; yÞÞ; v u v f13;14 ðf14;15 ðx; yÞ; f14;15 ðx; yÞÞÞ Á Á ÁÞ v u u v vm ¼ fm;mþ1 ðÁ Á Á ðf13;14 ðf14;15 ðx; yÞ; f14;15 ðx; yÞÞ; v u v f13;14 ðf14;15 ðx; yÞ; f14;15 ðx; yÞÞÞ Á Á ÁÞ for m \ 15

nuclei lose their spherical shape and appear as stacks of shifted discs.
Quantitative Assessment of Image Registration We applied standard and nonstandard methods to assess the accuracy of image registration. Pearson’s correlation coefficient (PCC) (53) was used to quantify the similarity between adjacent optical sections. To estimate the amount of blurring, we calculated the sum of pixel intensities of single MIP images derived from entire stacks. As the goal of our study was to restore the shape of biological structures in 3D image stacks, we performed a statistical analysis of foreground regions of the channel that shows cell nuclei. Thresholding was applied to segment the nuclei labeled by histone-H2B RFP. Prior to thresholding, we applied a median filter with a 5 3 5 kernel. To identify foreground regions in the red channel image, we applied a uniform threshold to all slices. Image processing including thresholding and contour extraction was performed using functions provided by the OpenCV computer vision library (54). Regions of interest (ROIs) were identified using connected component analysis. Subsequently, overlapping ROIs in neighboring optical slices were linked to construct 3D image objects. To quantify the degree of ROI alignment we determined the overlap ratio of pairs of overlapping ROIs within 3D objects. The overlap ratio was calculated as the ratio between the area of the intersection and the area of the smaller of the two ROIs. In addition, we determined the number of the nuclei, their size in number of voxels and the dimensions of the smallest cube that can accommodate the 3D connected component. To minimize the possibility of noise affecting the object statistics, we filtered out candidate nuclei of less than 900 voxels or approximately 1360 lm3. To exclude merged nuclei, we filtered out 3D objects containing more than 9000 voxels. To benchmark our registration method against established methods we used AutoAligner version 6.0.0 (Bitplane) (55) and the ImageJ plugins StackReg (22,56) and bUnwarpJ version 2.0 (57,58) for comparison.

ð21Þ

RESULTS
A subset of dorsal oblique muscles is destroyed before the onset of prepupal to pupal transition in Drosophila (10,13). To study the time-course of apoptosis in live muscles in greater detail, we performed 3D time-lapse microscopy of prepupae expressing two live cell markers; MHC-tauGFP to follow muscle breakdown and 24B-Gal4; UAS::HistoneH2B-RFP to monitor the state of the cell nucleus in muscles and other cells (Fig. 2). The dorsal external oblique muscles of the abdomen contain condensed nuclei indicating that these cells undergo apoptosis (Figs. 2B and 2G). As the breakdown of muscles and other larval tissues progresses, movements of the prepupal body inside the puparium increase in both intensity and frequency. This jitter, most likely caused by muscle contractions, leads to misalignments between the slices in the 3D image stacks. As a consequence, maximum intensity projections (MIPs) that generate sharp images when motion is negligible (Figs. 2D and 2E) become blurred (Figs. 2I and 2J). In addition, volumetric reconstructions of these live tissues reveal
335

u u u v um ¼ fm;mÀ1 ðÁ Á Á ðf17;16 ðf16;15 ðx; yÞ; f16;15 ðx; yÞÞ; v u v f17;16 ðf16;15 ðx; yÞ; f16;15 ðx; yÞÞÞ Á Á ÁÞ v u u v vm ¼ fm;mÀ1 ðÁ Á Á ðf17;16 ðf16;15 ðx; yÞ; f16;15 ðx; yÞÞ; v u v f17;16 ðf16;15 ðx; yÞ; f16;15 ðx; yÞÞÞ Á Á ÁÞ

for m [ 15

ð22Þ

Qualitative Assessment of Image Registration To visually assess the quality of image registration, we performed maximum intensity projections (MIP) using Zeiss LSM Image browser and isosurface rendering using Imaris (Bitplane). Misalignments result in blurred appearances of muscles and cell nuclei in MIP images, whereas these structures appear sharp when all the slices of an image stack are properly aligned. Volumetric surface rendering reveals geometric distortions caused by misalignments. When misaligned,
Cytometry Part A  75A: 329À343, 2009

ORIGINAL ARTICLE

Figure 2. Tissue movements during Drosophila metamorphosis result in image misalignments. All panels show dorsal views of a prepupal abdomen that were captured at two time points 58 minutes apart. A–E and K–L represent stack #1 at 0 minutes, while F–J and M–N represent stack #30 58 minutes later. (A, F) The live reporter MHC-tauGFP labels the dorsal external oblique muscles (DEOM, arrow) that undergoes histolysis (note difference in size of DEOM muscle fiber between 2A and 2F) and the dorsal internal oblique muscles (DIOM, arrow head). (B, G) Histone-RFP driven by 24B-Gal4 labels nuclei of muscles and other cell types. Arrows indicate condensed chromatin in apoptotic DEOMs, arrow heads nuclei of epidermal cells. (A–C, F–H) slice 12 out of 29 in the respective images stacks. (C, H) Superimpositions of MHC-tauGFP (green) and Histone-GFP (red) in single sections. (D, E) Maximum intensity projection (MIP) of all 29 sections of stack #1 when movements were negligible. (I, J) Movements of the animal during acquisition of the 3D image stack #30 lead to blurring of the MIPs. The projections lose structural details such as muscle striation and neurons (arrows) innervating muscles (compare D and I). (K–N) Iso-surface reconstructions of nuclei (red) are projected on top of MIPs of muscles (green). Panels L and N are magnifications of K and M, respectively. Image misalignments in stack #30 (N) result in geometrical distortions when compared to the spherical shape of nuclei in stack #1 recorded earlier (L). All scale bars represent 100 lm.

336

3D Reconstruction of Live Muscles

ORIGINAL ARTICLE
geometric distortions that transform the shapes of nuclei from spheres (Fig. 2L) to stacks of disks (Fig. 2N). To correct the above mentioned image misalignments we applied our nonrigid stack registration (NSR) algorithm. In the following section, we demonstrate the alignment results using stack #30 recorded at time point 58 minutes since it displayed the most severe jittering. The mapping functions were computed in three different fashions: using the red channel showing the nuclei (red mapping), using the green channel showing the muscle cytoplasm (green mapping), and using both channels as input (dual mapping). The performance of registration was assessed qualitatively as well as quantitatively. As the two channels were recorded nonsimultaneously, we expected that optimizing transformation parameters for one channel and then applying them to the other channel should lead to suboptimal registration performance. To estimate the accuracy of stack restoration we compared the output of the NSR algorithm with the unprocessed stack #1 recorded at time point 0 minutes (Figs. 2A–2E) since its image slices only showed negligible movements, yet appeared highly similar to stack 30 when compared with the level of individual slices (compare Figs. 2A with 2F, or 2B with 2G). Whether examined by MIP or 3D isosurface rendering, each of the registrations displayed a clear and discernible improvement over the original stack (Figure 3). Blurring was dramatically reduced and the neurons that appeared as dark veins on top of the muscles were clearly visible (compare Figs. 3E with 3F–3H). On close examination of reconstructed nuclei, we noticed subtle differences between the three different modes of registration. As expected, following red mapping, the isosurfaces of nuclei displayed the most spherical shapes (Fig. 3J), while green mapping resulted in the highest degree of misalignment (Fig. 3K). Dual mapping was judged to result in an intermediate quality of shape restoration (Fig. 3L). In contrast, the best alignments for muscles were observed for green, followed by dual and red mapping, with the area of the MIP of the muscle shown in Figures 3F–3H being 6.7% (dual) and 9.5% larger (red). Because of the discernible differences between registered and nonregistered image stacks, and between different mapping functions, we tested if the performance of the registration could be quantified in a way that correlates with human judgment. PCC measures similarity in pixel intensities between images and should reflect the differences in alignment between registered and nonregistered stacks (Table 1). As expected, the PCC between adjacent slices in both channels is significantly higher in stack #1 than in stack #30, 0.864 versus 0.653 for the red (P \ 0.001) and 0.915 versus 0.884 for the green channel (P 5 0.006, paired one-tailed t-test). Consistent with image restoration, registrations using all the three mapping modes lead to significantly higher PCC measurements for both the channels (P \ 0.001). In addition, consistent with the nonsynchronous recording of the red and green channels, mapping using the red (0.884) compared with the green channel (0.814) resulted in a higher PCC value (P 5 0.012, paired one-tailed t-test) while mapping using the green channel lead to a higher PCC of the green compared with the red channel (P 5 0.001). However, we also noticed cases where the PCC
Cytometry Part A  75A: 329À343, 2009

contradicted our perception. Although we judged the sharpness of muscle projection of the ground truth stack #1 (Fig. 2D) slightly higher than the restored MIPs resulting from red and dual mapping (Figs. 3F and 3H) its PCC was slightly lower (red mapping, P 5 0.046; dual mapping, P 5 0.025, paired one-tailed t-test). Furthermore, the PCC of stack #1 in the red channel was not significantly different from the restored stack after dual channel registration (P 5 0.614, paired two-tailed t-test). However, visualization by MIP and iso-surface rendering indicated discernible misalignments. The overlap ratios (OR) of ROIs corresponding to cell nuclei in the red channel showed a better correlation with the accuracy of image alignment. The value of 0.9740 was highest for stack #1 that was not distorted by jitter, followed by registered stacks in the perceived order according to the quality of image stack restoration (red 0.9451, dual 0.9105, green 0.8301). The lowest overlap ratio of 0.7496 was determined for the nonrestored stack #30. All the 5 measurements were significantly different from one another (P \ 0.001, one-tailed t-test). Features related to the 3D shape of nuclei were also helpful in assessing the accuracy of image restoration. As a result of misalignments we anticipated to see a loss in connectivity between corresponding ROIs along the axial direction. As expected, registration lead to an increase in the depth of the smallest bounding box (P \ 0.001, one-tailed t-test) and in volume (P \ 0.015) between stack #30 and the restored stacks. In contrast to the overlap ratio, the metrics were not sensitive enough to detect significant differences between the different mapping methods, or between ground truth and restored stacks. The size of the bounding box along the lateral dimension was more useful in identifying the mapping method achieving the best restoration of nuclear features compared to the gold standard stack #1. Registration based on red channel mapping, which resulted in average areas of 332 lm2 showed the smallest difference to stack #1 with an area of 309 lm2 (P 5 0.026). Larger nuclear ROI misalignments resulting from green and dual mapping were reflected in significantly larger bounding box areas (green mapping: 505.9 lm2, P \ 0.001; dual mapping: 369.6 lm2, P 5 0.001, one-tailed t-test) compared to obtaining transformation parameters from the red channel. Measuring the sum of intensities of MIPs appears a useful method to estimate the degree of blurring resulting from image misalignments. Consistent with our qualitative assessment, the reduction in sum of intensities resulting from registration was maximal for the channel for which the transformation parameters were optimized. A reduction of 22.7% in the nuclear channel was achieved by red mapping, a reduction of 9.5% by green mapping. To compare the performance of nonrigid and rigid methods in aligning images of deformable biological tissues, we evaluated the NSR algorithm compared with two existing linear 3D image stack registration tools: AutoAligner and StackReg (56). As quantitative analysis (Table 2) revealed, NSR performed slightly better than AutoAligner and StackReg at aligning image stacks. A PCC of 0.8843 was higher than respective values for AutoAligner (0.8579, P 5 0.003, paired one-tailed
337

ORIGINAL ARTICLE

Figure 3. The NSR method is able to restore dual channel 3D image stacks of muscle cell bodies and nuclei. In panels A to D and I to L, muscles are shown in green and nuclei in red. A and C show MIPs, B, D and I–L iso-surfaces. E–H show MIPs of muscles in grey—they are magnified views of the boxed regions in A and C. Mapping functions were estimated using the red (nuclei, F and J), green (muscles, J and K) or both channels (H and L). The motion induced blurring seen in the MIP of the stack recorded at 58 minutes (A) is greatly reduced by image registration (C). MIPs of reconstructed muscle cells (F–H) show structural details such as neurons (arrows) that appear fuzzy in the unprocessed image stack (E). A comparison of iso-surface renderings of the unaligned input (B, boxed region is enlarged in I) and the registered output (D, enlarged view of boxed region in J) reveals a restoration of the spherical shapes of nuclei. Note that the quality of alignment of nuclear regions (J–L) depends on the channels used to estimate the mapping function. All scale bars represent 100 lm.

338

3D Reconstruction of Live Muscles

ORIGINAL ARTICLE
Table 1. Quantitative evaluation of image registration
TIME POINT 0 58 MIN 58 MIN 58 MIN 58 MIN

Registration method Mapping channel PCC (red) PCC (green) Sum intensities MIP (green) Sum intensities MIP (red) Number of overlaps 2D ROI overlap ratios Number 3D objects Volume [lm3] Bounding box: area [lm2] Bounding box: depth [lm]

None – 0.864 Æ 0.075 0.915 Æ 0.073 77,295,816 (25.4%) 54,486,839 (222.5%) 3,036 0.974 Æ 0.074 307 4,296.3 Æ 2,286.1 309.9 Æ 136.0 35.1 Æ 12.4

None – 0.653 Æ 0.236 0.884 Æ 0.083 81,747,624 70,270,209 2,522 0.750 Æ 0.253 310 3,811.9 Æ 2,165.2 663.8 Æ 384.0 29.1 Æ 11.5

NSR Red 0.884 Æ 0.035 0.932 Æ 0.036 77,127,925 (25.65%) 54,319,913 (222.7%) 2,965 0.945 Æ 0.103 304 4,275.0 Æ 2,405.3 331.9 Æ 144.4 34.7 Æ 12.4

NSR Green 0.814 Æ 0.091 0.944 Æ 0.028 73,997,760 (29.5%) 60,506,149 (213.9%) 2,911 0.830 Æ 0.194 302 4,243.9 Æ 2,339.1 505.9 Æ 250.0 34.2 Æ 12.3

NSR Dual 0.871 Æ 0.039 0.934 Æ 0.034 76,534,339 (26.4%) 56,115,451 (220.1%) 2,952 0.911 Æ 0.130 305 4,220.3 Æ 2,300.3 369.6 Æ 161.31 34.3 Æ 12.0

The statistics of restored image stacks are compared with unprocessed 3D stacks at 0 (negligible motion) and 58 minutes (severe motion). To estimate the mapping functions, we used the red, the green or both channels. The Pearson’s correlation coefficient (PCC) is the mean value of 28 alignments per stack. The sum of intensities (SI) of maximum intensity projections (MIP) were calculated for the 29 images in each stack and channel. The values in brackets indicate the SIs relative to the unprocessed stack at time point 58. Negative values correlate with a reduction in blurring of the MIP. , the last 3 rows showing the mean values of the number of 3D objects. The sum of intensities of the MIPs is also shown in brackets relative to the distorted stack at 58 minutes.

t-test) and StackReg (0.8589, P 5 0.004). The overlap ratio of 0.945 was higher than in stacks aligned by AutoAligner (0.920, P \ 0.001) or StackReg (0.937, P 5 0.001). The bounding box areas were bigger for AutoAligner (366.9 lm2) than NSR (331.9 lm2, P 5 0.002, one-tailed t-test), indicating a lower alignment accuracy of nuclear ROIs. Consistent with this notion, we observe a small proportion of misaligned nuclei in the outputs of AutoAligner (Fig. 4D) that were not observed in the output of NSR (Fig. 4B). In contrast, the image stack restored by StackReg did not show a significant difference in area of the bounding box compared with NSR (P 5 0.56, two-

tailed t-test), while the iso-surfaces of nuclei did not show obvious misalignments (Fig. 4C). To test if the better performance of NSR was due to the ability to resolve nonlinear deformations, we applied NSR and StackReg to two pairs of images; one pair where misalignments (OR 5 0.141 Æ 0.154) appeared to be mainly due a uniform shift of all image regions (Figs. 5A and 5B) and another where the misalignments (OR 5 0.443 Æ 0.309) were more pronounced on one side of the image (Figs. 5E and 5F). In addition, we tested the ImageJ plugin bUnWarpJ which is able to perform nonrigid registration for image pairs, (but not

Table 2. Comparison of NSR with the registration methods AutoAligner and StackReg
TIME POINT 0 58 MIN 58 MIN 58 MIN 58 MIN

Registration method Mapping channel PCC (red) PCC (green) Sum intensities MIP (green) Sum intensities MIP (red) Number of overlaps 2D ROI overlap ratios Number 3D objects Volume [lm3] Bounding box: area [lm2] Bounding box: depth [lm]

None – 0.864 Æ 0.075 0.915 Æ 0.073 77,295,816 (25.4%) 54,486,839 (222.5%) 3,036 0.974 Æ 0.074 307 4,296.3 Æ 2,286.1 309.9 Æ 136.0 35.1 Æ 12.4

None – 0.653 Æ 0.236 0.884 Æ 0.083 81,747,624 70,270,209 2,522 0.750 Æ 0.253 310 3,811.9 Æ 2,165.2 663.8 Æ 384.0 29.1 Æ 11.5

NSR Red 0.884 Æ 0.035 0.932 Æ 0.036 77,127,925 (25.65%) 54,319,913 (222.7%) 2,965 0.945 Æ 0.103 304 4,275.0 Æ 2,405.3 331.9 Æ 144.4 34.7 Æ 12.4

Autoaligner Red 0.858 Æ 0.079 0.918 Æ 0.070 76,680,596 (26.2%) 55,596,311 (220.9%) 2,940 0.920 Æ 0.123 300 4,285.3 Æ 2,385.6 366.9 Æ 159.8 34.7 Æ 12.1

StackReg Red 0.859 Æ 0.074 75,344,043 (27.8%) 55,017,471 (221.7%) 2,936 0.937 Æ 0.089 302 4,135.9 Æ 2,289.7 338.8 Æ 151.8 34.5 Æ 12.3

Mean values were calculated in the same way as in Table1.

Cytometry Part A  75A: 329À343, 2009

339

ORIGINAL ARTICLE

Figure 4. Comparison of the NSR method with the linear registration tools AutoAligner and StackReg. The panels show iso-surface representations of cell nuclei (red) projected on top of MIPs of muscle cells (green). The regions of the image stacks at time point 58 minutes correspond to the boxed areas in Figures 3B and 3D; (A) before registration and after registration using (B) the proposed NSR method, (C) AutoAligner, and (D) StackReg. All scale bars represent 100 lm.

recursive registration of image stacks). For the first image pair, both algorithms produced similar alignment results (Figs. 5C and 5D). Alignment accuracy measured by mean overlap ratios showed slightly higher values for NSR (OR 5 0.962 Æ 0.080) than StackReg (OR 5 0.944 Æ 0.083, P 5 0.032, onetailed t-test). Consistent with the idea that NSR has an advantage in resolving nonlinear deformations that occur in a subset of misaligned muscle images, NSR produced more accurate registration results for the second image pair than StackReg (Figs. 5G and 5H). The image pair registered by StackReg shows many incompletely aligned nuclei (Fig. 5H, arrows). Consistent with this observation, the OR values between reference and restored target images of (OR 5 0.935 Æ 0.120) for NSR was significantly higher than the value of (OR 5 0.832 Æ 0.195) for StackReg (P \ 0.001, one-tailed t-test). Plotting the MSE against the iterations of linear and nonlinear registration shows that the nonlinear component of the NSR algorithm has greater contribution in aligning the second than the first image pair (Fig. 5I). Furthermore, to compare NSR with another nonrigid registration method, we tested the ImageJ plugin bUnWarpJ on the two image pairs. The OR values did not significantly differ for either the linear (0.962 Æ 0.092,
340

P 5 0.949, two-tailed t-test) or nonlinear case (0.913 Æ 0.131, P 5 0.143, two-tailed t-test), confirming our notion that nonrigid registration methods can produce more accurate alignments than rigid ones in live cell microscopy. Our method takes approximately 45 minutes to register an entire image stack of 29 slices with a size of 1024 3 1024 pixels, whereas StackReg requires 11 minutes and Autoaligner 34 minutes. One plausible reason for the slower execution is higher computational complexity as the nonrigid NSR registration method has to optimize a larger number of parameters than the two linear registration methods. Another reason is that our code was implemented in Matlab. As such, we expect an implementation in C or Java to run significantly faster.

DISCUSSION
3D time-lapse microscopy promises to provide novel insights into the dynamics of animal development. However, rapid movements of live tissues can lead to misalignments between the optical sections of 3D image stacks. To improve 3D reconstruction and subsequent visualization and quantitative analysis of fluorescently labeled live muscles in Drosophila metamorphosis we developed a fully-automated, nonrigid
3D Reconstruction of Live Muscles

ORIGINAL ARTICLE
intensity-based registration method. To help us quantify the performance of the registration algorithm, we devised a benchmarking method that takes advantage of a second fluorescent protein expressed in cell nuclei. Most established image registration tools in biology were designed for the alignment of fixed serial sections and, as such, are only capable of performing linear transformations between reference and target images. As many biological structures such as muscles and other soft tissues are deformable, nonrigid are likely to outperform rigid methods in live cell microscopy. Assessing the 3D reconstruction of muscles by qualitative and quantitative criteria, our NSR method achieved more accurate alignment than methods that perform linear transformations. When misalignments were judged to be mainly the result of linear translation, the two linear registration methods tested showed alignment accuracy comparable with our method. An issue in nonrigid registration in medical imaging is the lack of validation methods for the correctness of image alignment (44). As we could demonstrate in this study, biological imaging of deformable tissues can offer an avenue to measure the performance of nonrigid, intensity-based registration algorithms. In quantitative microscopy, labeling nuclei facilitates many image analysis tasks, including counting cells, tracking or classifying cells (59). Here, we exploited the fluorescence labeling of spherically shaped nuclei to quantify the accuracy of image registration. As the discrete ROIs corresponding to nuclei are distributed throughout the tissue we were able to quantify and visualize alignment in most regions of the 3D scene represented by the image stack. A very useful metric turned out to be the overlap ratio between binarized ROIs that represent sections of nuclei. In our experiments, it showed better correlation with visual inspection than the conventional PCC. High overlap ratios along with corresponding shape feature values (volume, minimal bounding box of connected set of ROIs) agreed with values determined for the ground truth data set, and as such are important criteria for validation. An important ingredient of our quantification procedure is that certain time-points (e.g. time point #1) with negligible tissue movements can serve as the ground-truth in the validation of stack registration. In summary, multidimensional biological image data like the 3D time-lapse of Drosophila metamorphosis can play an important role in benchmarking nonrigid image registration algorithms.

Figure 5. Pair wise comparison of alignment accuracy between NSR and Stackreg. We contrast two cases of superimposed image pairs, with nuclei of reference image shown in white and those of the target image in red. (A, magnification in B) In the first ‘linear’ case, all nuclei are shifted in a predominantly uniform fashion. (E, magnification in F) In the second ‘nonlinear’ case, nuclei in the top right corner (arrows) show greater misalignments than nuclei (arrow heads) located at the bottom left of the image. (C, G) The NSR method is able to align both pairs of images. (D, H) StackReg produces comparable results to the NSR method in the linear case (E) but fails to completely correct the misalignment of nuclei in the nonlinear case (G). (I) The mean square error (MSE) in intensities between subsequent images of the two cases is plotted against the number of iterations of the NSR. The nonlinear component of the registration algorithm reduces the MSE of the nonlinear case. In contrast, the influence on the linear case in negligible. All scale bars represent 100 lm.

Cytometry Part A  75A: 329À343, 2009

341

ORIGINAL ARTICLE
We would like to stress that our method will not work universally for all registration problems. For instance a column-shaped nucleus whose main axis is neither parallel to the z-axis nor the xy-plane might be wrongly aligned to become a sphere. Therefore, a validation using a ground truth dataset must be applied to ensure that the features of restored objects are correct. In cases, where correctly aligned stacks of live animals cannot be acquired, body movements can be suppressed by anesthesia, or alternatively, tissues might be fixed by crosslinking agents. The main contribution of this article is the development of a fully automated deformable image registration method that facilitates 3D reconstruction in live cell microscopy. We solved the misalignment problems of the image stacks showing muscle cells in Drosophila metamorphosis. We expect our method to be applicable to other processes in development and to other model systems like zebrafish. In addition, we also provide a new benchmarking method that measures the performance of registration algorithms with respect to restoring structural features of cell nuclei.
16. Goobic AP, Tang J, Acton ST. Image stabilization and registration for tracking cells in the microvasculature. IEEE Trans Biomed Eng 2005;52:287–299. 17. Liebling M, Forouhar AS, Wolleschensky R, Zimmermann B, Ankerhold R, Fraser SE, Gharib M, Dickinson ME. Rapid three-dimensional imaging and analysis of the beating embryonic heart reveals functional changes during development. Dev Dyn 2006;235:2940–2948. 18. Brown LG. A survey of image registration techniques. ACM Comput Surv 1992; 24:326–376. 19. Zitova B, Flusser J. Image registration methods: A Survey. Image Vis Comput 2003;21:977–1000. 20. Goshtasby A, Stockman GC, Page CV. A region-based approach to digital image registration with subpixel accuracy. IEEE Trans Geosci Remote Sensing 1986;24:390– 399. 21. Steiner D, Kirby ME. Geometrical referencing of Landsat images by affine transformation and overlaying of map data. Photogrammetria 1977;33:41–75. 22. Thevenaz P, Ruttimann UE, Unser M. A pyramid approach to subpixel registration based on intensity. IEEE Trans Image Process 1998;7:27–41. 23. Wie PV, Stein M. A landsat digital image rectification system. IEEE Trans. Geosci Electron 1977;15:130–137. 24. Goshtasby A. Piecewise linear mapping functions for image registration. Pattern Recognit 1986;19:459–466. 25. Bajcsy R, Kovacic S. Multiresolution elastic matching. Comput Vis Graph Image Process 1989;46:1–21. 26. Goshtasby A. Registration of images with geometric distortion. IEEE Trans Geosci Remote Sensing 1988;26:60–64. 27. Jan F. An adaptive method for image registration. Pattern Recognit 1992;25:45–54. 28. Ehlers M, Fogel DN. High-precision geometric correction of airborne remote sensing revisited: The multiquadric interpolation. International Conference on Image and Signal Processing for Remote Sensing. Rome, Italy; 1994: pp 814–824. 29. Little JA, Hill DLG, Hawkes DJ. Deformations Incorporating Rigid Structures. Proceedings of the 1996 Workshop on Mathematical Methods in Biomedical Image Analysis (MMBIA ’96): IEEE Comput Soc; 1996. p 104. 30. Fornefett M, Rohr K, Stiehl HS. Radial basis functions with compact support for elastic registration of medical images. Image Vis Comput 2001;19:87–96. 31. Rohr K, Stiehl HS, Sprengel R, Buzug TM, Weese J, Kuhn MH. Landmark-based elastic registration using approximating thin-plate splines. IEEE Trans Med Imaging 2001;20:526–534. 32. Fogel DN. Image rectification with radial basis functions: Application to RS/GIS data integration. Proceedings of the Third International Conference on Integrating GIS and Environmental Modeling. Santa Fe, New Mexico; 1996; p 19. 33. Wiemker R, Rohr K, Binder L, Sprengel R, Stiehl HS. Application of elastic registration to imaginery from airborne scanners. Int Arch Photogrammetry Remote Sensing 1996:949–954. 34. Goshtasby A, Stockman GC. Point pattern matching using convex hull edges. IEEE Trans Syst Man Cybern 1985;15:631–637. 35. Hanaizumi H, Fujimura S. An automated method for registration of satellite remote sensing images. Proceedings of the International Geoscience and Remote Sensing Symposium IGARSS’93. Tokyo, Japan; 1993. pp 1348–1350. 36. Simper A. Correcting general band-to-band misregistrations. IEEE International Conference on Image Processing, 1996. pp 597–600. 37. Berthilsson R. Affine correlation. International Conference on Pattern Recognition. Brisbane, Australia; 1998. p 239–254. 38. Catro ED, Morandi C. Registration of translated and rotated images using finite Fourier transform. IEEE Trans Pattern Anal Mach Intell 1987;29:700–703. 39. Reddy BS, Chatterji BN. An FFT-based technique for translation, rotation and scaleinvariant image registration. IEEE Trans Image Process 1996;5:1266–1271. 40. Maes F, Collignon A, Vandermeulen D, Marchal G, Suetens P. Multimodality image registration by maximization of mutual information. IEEE Trans Med Imaging 1997;16:187–198. 41. Viola P, Wells WM. Alignment by maximization of mutual information. Int J Comput Vis 1997;24:137–154. 42. Thevenaz P, Unser M. An efficient mutual information optimizer for multiresolution image registration. Proceedings of the IEEE International Conference on Image Processing ICIP’98. Chicago, IL; 1998. pp 833–837. 43. West J, Fitzpatrick JM, Wang MY, Dawant BM, Maurer CR, Jr., Kessler RM, Maciunas RJ, Barillot C, Lemoine D, Collignon A, Maes F, Sumanaweera TS, Harkhess B, Hemler PF, Hill DLG, Hawkes DJ, Studholme C, Maintz JBA, Viergever MA, Mal G, Pennec X, Noz ME, Maguire GQ, Pollack M, Pelizzari CA, Robb RA, Hanson D, Woods RP. Comparison and evaluation of retrospective intermodality brain image registration techniques. J Comput Assist Tomogr 1997;21:554–566. 44. Crum WR, Griffin LD, Hill DL, Hawkes DJ. Zen and the art of medical image registration: Correspondence, homology, and quality. Neuroimage 2003;20:1425– 1437. 45. Chen EH, Olson EN. Antisocial, an intracellular adaptor protein, is required for myoblast fusion in Drosophila. Dev Cell 2001;1:705–715. 46. Brand AH, Dormand EL. The GAL4 system as a tool for unravelling the mysteries of the Drosophila nervous system. Curr Opin Neurobiol 1995;5:572–578. 47. Langevin J, Le Borgne R, Rosenfeld F, Gho M, Schweisguth F, Bellaiche Y. Lethal giant larvae controls the localization of notch-signaling regulators numb, neuralized, and Sanpodo in Drosophila sensory-organ precursor cells. Curr Biol 2005;15:955– 962. 48. Majlof L, Forsgren PO. Confocal microscopy: Important considerations for accurate imaging. Methods Cell Biol 1993;38:79–95.

ACKNOWLEDGMENTS
The authors thank their colleagues W.M. Yu, C. Rambabu, J. Kriston-Vizi, P.W. Choo, Y. Xiao, and H. K. Lee for their help and discussion. We thank E. Chen and E. Olson for the MHCtauGFP and Y. Bellaiche for the UAS-H2B-RFP stock. We thank the Biopolis Shared Facilities for help with confocal microscopy.

LITERATURE CITED
1. Shimomura O, Johnson FH, Saiga Y. Extraction, purification and properties of aequorin, a bioluminescent protein from the luminous hydromedusan. Aequorea. J Cell Comp Physiol 1962;59:223–239. 2. Chalfie M, Tu Y, Euskirchen G, Ward WW, Prasher DC. Green fluorescent protein as a marker for gene expression. Science 1994;263:802–805. 3. Shaner NC, Steinbach PA, Tsien RY. A guide to choosing fluorescent proteins. Nat Methods 2005;2:905–909. 4. Conchello JA, Lichtman JW. Optical sectioning microscopy. Nat Methods 2005; 2:920–931. 5. Nakano A. Spinning-disk Confocal Microscopy—A cutting-edge tool for imaging of membrane traffic. Cell Struct Funct 2002;5:349–355. 6. Wolleschensky R, Zimmermann B, Kempe M. High-speed confocal fluorescence imaging with a novel line scanning microscope. J Biomed Opt 2006;11:064011. 7. Huisken J, Swoger J, Del Bene F, Wittbrodt J, Stelzer EH. Optical sectioning deep inside live embryos by selective plane illumination microscopy. Science 2004; 305:1007–1009. 8. Keller PJ, Schmidt AD, Wittbrodt J, Stelzer EH. Reconstruction of zebrafish early embryonic development by scanned light sheet microscopy. Science 2008;322:1065–1069. 9. Bodenstein D. The Postembryonic Development of Drosophila. In: Demerec M, editor. Biology of Drosophila. New York and London: Hafner Publishing Company; 1965. pp 275–367. 10. Ward RE, Reid P, Bashirullah A, D’Avino PP, Thummel CS. GFP in living animals reveals dynamic developmental responses to ecdysone during Drosophila metamorphosis. Dev Biol 2003;256:389–402. 11. Takemoto K, Kuranaga E, Tonoki A, Nagai T, Miyawaki A, Miura M. Local initiation of caspase activation in Drosophila salivary gland programmed cell death in vivo. Proc Natl Acad Sci USA 2007;104:13367–13372. 12. Kimura KI, Truman JW. Postmetamorphic cell death in the nervous and muscular systems of Drosophila melanogaster. J Neurosci 1990;10:403–411. 13. Wasser M, Bte Osman Z, Chia W. EAST and Chromator control the destruction and remodeling of muscles during Drosophila metamorphosis. Dev Biol 2007;307:380– 393. 14. Megason SG, Fraser SE. Digitizing life at the level of the cell: High-performance laserscanning microscopy and image analysis for in toto imaging of development. Mech Dev 2003;120:1407–1420. 15. Meijering E, Smal I, Dzyubachyk O, Olivo-Marin JC. Time-Lapse Microscopy Imaging. In: Wu Q, Merchant F, Castleman K, editors. Microscope Image Processing. Burlington, MA: Elsevier Academic Press; 2008; p 401–440.

342

3D Reconstruction of Live Muscles

ORIGINAL ARTICLE
49. Bookstein FL. Principal Warps: Thin-plate splines and the decomposition of deformations. Pattern Anal Mach Intell 1989;11:567–585. 50. Bilge K. Estimating topology preserving and smooth displacement fields. IEEE Trans Med Imaging 2004;23:868–880. 51. Wang S, Ji JX, Liang ZP. Landmark-based shape deformation with topology-preserving constraints. Proceedings of the Ninth IEEE International Conference on Computer Vision; 2003. pp 923–930. 52. Musse O, Heitz F, Armspach JP. Topology preserving deformable image matching using constrained hierarchical parametric models. IEEE Trans. Image Process 2001;10:1081–1093. 53. Csapo I, Holland C, Guttmann C. Image registration framework for large-scale longitudinal MRI data sets: Strategy and validation. Magn Reson Imaging 2007;25:889– 893. 54. OpenCV, Available at http://sourceforge.net/projects/opencvlibrary. 55. Bitplane. AutoAligner, Version 6, Available at http://www.bitplane.com/go/products/ autoaligner. 56. Thevenaz P. StackReg. Available at http://bigwww.epfl.ch/thevenaz/stackreg/; 2005. 57. Arganda-Carreras I, Sorzano COS, Marabini R, Carazo JM, Ortiz de Solorzano C, Kybic J. Consistent and Elastic Registration of Histological Sections using VectorSpline Regularization. CVAMIA: Computer Vision Approaches to Medical Image Analysis, Lecture Notes in Computer Science 2006;4241:85–95. ´ ´ ´ 58. Arganda-Carreras COSS I, Marabini R, Marıa Carazo J, Ortiz-de-Solorzano C, Kybic J. bUnwarpJ, Version 2.0, Available at http://biocomp.cnb.uam.es/$iarganda/ bUnwarpJ/; 2008. 59. Lin G, Chawla MK, Olson K, Barnes CA, Guzowski JF, Bjornsson C, Shain W, Roysam B. A multi-model approach to simultaneous segmentation and classification of heterogeneous populations of cell nuclei in 3D confocal microscope images. Cytometry Part A 2007;71A:724–736.

Cytometry Part A  75A: 329À343, 2009

343

